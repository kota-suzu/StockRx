<% content_for :title, "パスワード変更" %>
<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item">
    <%= link_to "プロフィール", store_profile_path %>
  </li>
  <li class="breadcrumb-item active">パスワード変更</li>
<% end %>

<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-key me-2"></i>
          パスワード変更
        </h5>
      </div>
      <div class="card-body">
        <% if @must_change %>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-1"></i>
            初回ログインまたはパスワードの有効期限が切れています。パスワードを変更してください。
          </div>
        <% elsif @password_expires_in && @password_expires_in <= 7 %>
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-1"></i>
            パスワードの有効期限があと<%= @password_expires_in %>日です。
          </div>
        <% end %>
        
        <%= form_with model: @user, url: store_update_password_profile_path, method: :patch do |f| %>
          <%# エラー表示 %>
          <% if @user.errors.any? %>
            <div class="alert alert-danger">
              <ul class="mb-0">
                <% @user.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          
          <%# 現在のパスワード %>
          <div class="mb-3">
            <%= f.label :current_password, class: "form-label required" %>
            <%= f.password_field :current_password, 
                                class: "form-control",
                                required: true,
                                autocomplete: "current-password" %>
          </div>
          
          <%# 新しいパスワード %>
          <div class="mb-3">
            <%= f.label :password, "新しいパスワード", class: "form-label required" %>
            <%= f.password_field :password, 
                                class: "form-control",
                                required: true,
                                autocomplete: "new-password" %>
            <div class="form-text">
              12文字以上で、大文字・小文字・数字・記号を含めてください
            </div>
          </div>
          
          <%# パスワード確認 %>
          <div class="mb-4">
            <%= f.label :password_confirmation, class: "form-label required" %>
            <%= f.password_field :password_confirmation, 
                                class: "form-control",
                                required: true,
                                autocomplete: "new-password" %>
          </div>
          
          <%# パスワード強度表示 %>
          <div class="mb-4">
            <label class="form-label">パスワード強度</label>
            <div class="password-strength-meter">
              <div class="progress" style="height: 5px;">
                <div class="progress-bar" role="progressbar" id="password-strength-bar"></div>
              </div>
              <small class="text-muted" id="password-strength-text">パスワードを入力してください</small>
            </div>
          </div>
          
          <div class="d-flex justify-content-between">
            <%= link_to "キャンセル", store_profile_path, class: "btn btn-secondary" %>
            <%= f.submit "パスワードを変更", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
    
    <%# パスワードポリシー %>
    <div class="card mt-3">
      <div class="card-body">
        <h6 class="text-muted mb-3">
          <i class="fas fa-info-circle me-1"></i>
          パスワードポリシー
        </h6>
        <ul class="small mb-0">
          <li>最小12文字以上</li>
          <li>大文字（A-Z）を1文字以上含む</li>
          <li>小文字（a-z）を1文字以上含む</li>
          <li>数字（0-9）を1文字以上含む</li>
          <li>記号を1文字以上含む</li>
          <li>過去のパスワードは使用不可（Phase 5で実装予定）</li>
          <li>90日ごとに変更が必要</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  // パスワード強度チェック
  document.addEventListener('DOMContentLoaded', function() {
    const passwordField = document.getElementById('store_user_password');
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');
    
    if (passwordField) {
      passwordField.addEventListener('input', function() {
        const password = this.value;
        let strength = 0;
        let strengthClass = '';
        let strengthMessage = '';
        
        // 長さチェック
        if (password.length >= 12) strength += 25;
        if (password.length >= 16) strength += 10;
        
        // 文字種チェック
        if (/[a-z]/.test(password)) strength += 15;
        if (/[A-Z]/.test(password)) strength += 15;
        if (/[0-9]/.test(password)) strength += 15;
        if (/[^A-Za-z0-9]/.test(password)) strength += 20;
        
        // 強度の評価
        if (strength < 30) {
          strengthClass = 'bg-danger';
          strengthMessage = '弱い';
        } else if (strength < 60) {
          strengthClass = 'bg-warning';
          strengthMessage = '普通';
        } else if (strength < 80) {
          strengthClass = 'bg-info';
          strengthMessage = '強い';
        } else {
          strengthClass = 'bg-success';
          strengthMessage = 'とても強い';
        }
        
        strengthBar.className = 'progress-bar ' + strengthClass;
        strengthBar.style.width = strength + '%';
        strengthText.textContent = strengthMessage;
      });
    }
  });
</script>