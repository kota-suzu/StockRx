<% content_for :title, "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›" %>

<style>
  /* ãƒ¢ãƒ€ãƒ³ãªç™½ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚¶ã‚¤ãƒ³ - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¨ã®çµ±ä¸€æ€§ç¢ºä¿ */
  :root {
    --primary-color: #0d6efd;
    --success-color: #198754;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --light-bg: #f8f9fa;
    --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
    --border-radius: 0.75rem;
    --transition: all 0.2s ease-in-out;
  }
  
  /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .auth-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 2rem 1rem;
  }
  
  /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
  .auth-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    border: 1px solid rgba(0, 0, 0, 0.05);
    overflow: hidden;
    max-width: 480px;
    margin: 0 auto;
  }
  
  .auth-card-body {
    padding: 3rem 2rem;
  }
  
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .auth-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  
  .auth-icon {
    width: 4rem;
    height: 4rem;
    background: linear-gradient(135deg, var(--success-color), #20c997);
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-sm);
  }
  
  .auth-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #212529;
    margin-bottom: 0.5rem;
  }
  
  .auth-subtitle {
    color: #6c757d;
    font-size: 1rem;
    line-height: 1.5;
  }
  
  /* ã‚¹ãƒˆã‚¢æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .store-info {
    background: var(--light-bg);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border: 1px solid #dee2e6;
  }
  
  .store-info-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.25rem;
    display: block;
  }
  
  .store-info-value {
    font-size: 1rem;
    font-weight: 500;
    color: #212529;
    margin: 0;
  }
  
  /* ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
  .passcode-input {
    font-size: 2rem;
    letter-spacing: 0.75rem;
    text-align: center;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
    font-weight: 600;
    padding: 1rem;
    border: 2px solid #dee2e6;
    border-radius: 0.5rem;
    transition: var(--transition);
    background: #fafbfc;
  }
  
  .passcode-input:focus {
    border-color: var(--primary-color);
    background: white;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    outline: none;
  }
  
  .passcode-input.is-valid {
    border-color: var(--success-color);
    background: #f8fff8;
  }
  
  .passcode-input.is-invalid {
    border-color: var(--danger-color);
    background: #fff8f8;
  }
  
  /* ãƒ•ã‚©ãƒ¼ãƒ ãƒ©ãƒ™ãƒ« */
  .form-label-enhanced {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
  .btn-submit {
    background: linear-gradient(135deg, var(--success-color), #20c997);
    border: none;
    color: white;
    font-weight: 600;
    padding: 0.875rem 2rem;
    border-radius: 0.5rem;
    transition: var(--transition);
    width: 100%;
    font-size: 1.1rem;
  }
  
  .btn-submit:hover:not(:disabled) {
    background: linear-gradient(135deg, #157347, #198754);
    transform: translateY(-1px);
    box-shadow: 0 0.5rem 1rem rgba(25, 135, 84, 0.3);
    color: white;
  }
  
  .btn-submit:disabled {
    opacity: 0.65;
    transform: none;
    cursor: not-allowed;
  }
  
  /* ãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ« */
  .auth-links {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1.5rem;
    gap: 1rem;
  }
  
  .auth-link {
    text-decoration: none;
    font-weight: 500;
    color: var(--primary-color);
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.9rem;
  }
  
  .auth-link:hover {
    color: #0b5ed7;
    text-decoration: none;
  }
  
  .auth-link.secondary {
    color: #6c757d;
  }
  
  .auth-link.secondary:hover {
    color: #495057;
  }
  
  /* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ± */
  .security-info {
    background: #fff3cd;
    border: 1px solid #ffecb5;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1.5rem;
  }
  
  .security-info-header {
    font-weight: 600;
    color: #664d03;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .security-info-list {
    list-style: none;
    padding: 0;
    margin: 0;
    color: #664d03;
    font-size: 0.875rem;
  }
  
  .security-info-list li {
    margin-bottom: 0.25rem;
    padding-left: 1rem;
    position: relative;
  }
  
  .security-info-list li::before {
    content: "â€¢";
    position: absolute;
    left: 0;
    color: var(--warning-color);
    font-weight: bold;
  }
  
  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  .auth-footer {
    background: var(--light-bg);
    border-top: 1px solid #dee2e6;
    padding: 1rem 2rem;
    text-align: center;
  }
  
  .secure-connection {
    color: #6c757d;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(2rem);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-slide-in {
    animation: slideInUp 0.6s ease-out;
  }
  
  /* ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
  .form-text-enhanced {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .invalid-feedback {
    font-size: 0.875rem;
    color: var(--danger-color);
    margin-top: 0.5rem;
  }
  
  .valid-feedback {
    font-size: 0.875rem;
    color: var(--success-color);
    margin-top: 0.5rem;
  }
  
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
  @media (max-width: 576px) {
    .auth-container {
      padding: 1rem 0.5rem;
    }
    
    .auth-card-body {
      padding: 2rem 1.5rem;
    }
    
    .auth-title {
      font-size: 1.5rem;
    }
    
    .passcode-input {
      font-size: 1.75rem;
      letter-spacing: 0.5rem;
    }
    
    .auth-links {
      flex-direction: column;
      gap: 0.75rem;
      text-align: center;
    }
  }
  
  /* Focusç®¡ç† */
  .form-control:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  
  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ */
  .loading {
    position: relative;
    overflow: hidden;
  }
  
  .loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
    animation: loading 1.5s infinite;
  }
  
  @keyframes loading {
    0% { left: -100%; }
    100% { left: 100%; }
  }
</style>

<div class="auth-container d-flex align-items-center justify-content-center">
  <div class="w-100">
    <div class="auth-card animate-slide-in">
      
      <!-- ã‚«ãƒ¼ãƒ‰æœ¬ä½“ -->
      <div class="auth-card-body">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="auth-header">
          <div class="auth-icon">
            <i class="bi bi-shield-lock fs-2 text-white"></i>
          </div>
          <h1 class="auth-title">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</h1>
          <p class="auth-subtitle">
            ãƒ¡ãƒ¼ãƒ«ã§å—ä¿¡ã—ãŸ6æ¡ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
          </p>
        </div>

        <!-- ã‚¹ãƒˆã‚¢æƒ…å ± -->
        <div class="store-info">
          <label class="store-info-label">
            <i class="bi bi-building"></i>
            åº—èˆ—å
          </label>
          <p class="store-info-value"><%= @store.name %></p>
        </div>

        <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
        <%= form_with model: @temp_password_verification,
                      url: store_verify_temp_password_path(store_slug: @store.slug),
                      local: true,
                      id: "passcode-verify-form",
                      class: "needs-validation",
                      novalidate: true do |form| %>
          
          <!-- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¡¨ç¤º -->
          <div class="mb-4">
            <div class="store-info">
              <label class="store-info-label">
                <i class="bi bi-envelope"></i>
                é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
              </label>
              <p class="store-info-value"><%= @masked_email %></p>
              <%= form.hidden_field :email, value: @temp_password_verification.email %>
            </div>
          </div>

          <!-- ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ› -->
          <div class="mb-4">
            <label class="form-label-enhanced" for="temp_password_field">
              <i class="bi bi-shield-lock"></i>
              6æ¡ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰
            </label>
            <%= form.text_field :temp_password,
                                placeholder: "â€¢â€¢â€¢â€¢â€¢â€¢",
                                required: true,
                                autocomplete: "one-time-code",
                                maxlength: 6,
                                pattern: "[0-9]{6}",
                                inputmode: "numeric",
                                id: "temp_password_field",
                                class: "form-control passcode-input",
                                aria_describedby: "passcode-help",
                                aria_label: "6æ¡ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" %>
            <div id="passcode-help" class="form-text-enhanced">
              <i class="bi bi-clock"></i>
              ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯15åˆ†é–“æœ‰åŠ¹ã§ã™
            </div>
            <div class="invalid-feedback">
              6æ¡ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„
            </div>
            <div class="valid-feedback">
              ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã¾ã—ãŸ
            </div>
          </div>

          <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
          <%= form.hidden_field :store_id, value: @store.id %>
          <%= form.hidden_field :store_slug, value: @store.slug %>

          <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
          <div class="mb-4">
            <%= form.submit "ãƒ­ã‚°ã‚¤ãƒ³",
                            id: "submit-passcode",
                            class: "btn btn-submit",
                            data: { 
                              disable_with: "ãƒ­ã‚°ã‚¤ãƒ³ä¸­...",
                              loading_text: "ãƒ­ã‚°ã‚¤ãƒ³ä¸­..."
                            } %>
          </div>

          <!-- ãƒªãƒ³ã‚¯ -->
          <div class="auth-links">
            <%= link_to new_store_user_session_path(store_slug: @store.slug),
                        class: "auth-link" do %>
              <i class="bi bi-arrow-left"></i>
              ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡
            <% end %>
            <%= link_to store_selection_path,
                        class: "auth-link secondary" do %>
              <i class="bi bi-shop"></i>
              åˆ¥ã®åº—èˆ—ã‚’é¸æŠ
            <% end %>
          </div>
        <% end %>

        <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ± -->
        <div class="security-info">
          <div class="security-info-header">
            <i class="bi bi-shield-exclamation"></i>
            ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±
          </div>
          <ul class="security-info-list">
            <li>ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯1å›é™ã‚Šä½¿ç”¨å¯èƒ½ã§ã™</li>
            <li>5å›é–“é•ãˆã‚‹ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™</li>
            <li>ä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’æ¤œçŸ¥ã—ãŸå ´åˆã¯ç®¡ç†è€…ã«ã”é€£çµ¡ãã ã•ã„</li>
          </ul>
        </div>
      </div>

      <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
      <div class="auth-footer">
        <div class="secure-connection">
          <i class="bi bi-shield-check"></i>
          <span>å®‰å…¨ãªæ¥ç¶šã§ä¿è­·ã•ã‚Œã¦ã„ã¾ã™</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ã®å¼·åŒ–ã•ã‚ŒãŸJavaScript
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('passcode-verify-form');
  const submitButton = document.getElementById('submit-passcode');
  const passcodeField = document.getElementById('temp_password_field');
  
  // Bootstrap 5ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (form) {
    form.addEventListener('submit', function(event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã‚µãƒãƒ¼ãƒˆ
        const firstInvalidField = form.querySelector(':invalid');
        if (firstInvalidField) {
          firstInvalidField.focus();
          firstInvalidField.setAttribute('aria-invalid', 'true');
        }
      }
      form.classList.add('was-validated');
    });
  }
  
  // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨æ¤œè¨¼
  if (passcodeField) {
    // å…¥åŠ›æ™‚ã®å‡¦ç†
    passcodeField.addEventListener('input', function(e) {
      // æ•°å­—ä»¥å¤–ã‚’å‰Šé™¤
      let value = this.value.replace(/[^0-9]/g, '');
      this.value = value;
      
      // é•·ã•åˆ¶é™
      if (value.length > 6) {
        this.value = value.slice(0, 6);
      }
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      updateFieldValidation(this);
      
      // 6æ¡å…¥åŠ›å®Œäº†æ™‚ã®è‡ªå‹•å‡¦ç†
      if (this.value.length === 6) {
        // è»½å¾®ãªé…å»¶å¾Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ãƒœã‚¿ãƒ³ã«ç§»å‹•
        setTimeout(() => {
          submitButton.focus();
        }, 100);
      }
    });
    
    // ãƒšãƒ¼ã‚¹ãƒˆæ™‚ã®å‡¦ç†
    passcodeField.addEventListener('paste', function(e) {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      const numbers = pastedText.replace(/[^0-9]/g, '').slice(0, 6);
      this.value = numbers;
      
      // inputã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼
      const inputEvent = new Event('input', { bubbles: true });
      this.dispatchEvent(inputEvent);
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
      updateFieldValidation(this);
    });
    
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«å…¨é¸æŠ
    passcodeField.addEventListener('focus', function() {
      // çŸ­ã„é…å»¶å¾Œã«é¸æŠï¼ˆä¸€éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§å¿…è¦ï¼‰
      setTimeout(() => {
        this.select();
      }, 10);
    });
    
    // ã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ•°å­—ã‚­ãƒ¼ã®ã¿è¨±å¯ï¼‰
    passcodeField.addEventListener('keydown', function(e) {
      // è¨±å¯ã•ã‚Œã‚‹ã‚­ãƒ¼
      const allowedKeys = [
        'Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'Home', 'End',
        'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'
      ];
      
      // æ•°å­—ã‚­ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰
      const isNumber = e.key >= '0' && e.key <= '9';
      // æ•°å­—ã‚­ãƒ¼ï¼ˆãƒ†ãƒ³ã‚­ãƒ¼ï¼‰
      const isNumpad = e.code.startsWith('Numpad') && e.key >= '0' && e.key <= '9';
      // Ctrl/Cmd + A, C, V, X (ã‚³ãƒ”ãƒšå¯¾å¿œ)
      const isCtrlCmd = e.ctrlKey || e.metaKey;
      const isCopyPaste = isCtrlCmd && ['a', 'c', 'v', 'x'].includes(e.key.toLowerCase());
      
      if (!isNumber && !isNumpad && !allowedKeys.includes(e.key) && !isCopyPaste) {
        e.preventDefault();
      }
    });
  }
  
  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®æ›´æ–°
  function updateFieldValidation(field) {
    const value = field.value;
    const isValid = /^[0-9]{6}$/.test(value);
    const isEmpty = value.length === 0;
    
    // ã‚¯ãƒ©ã‚¹ã®ãƒªã‚»ãƒƒãƒˆ
    field.classList.remove('is-valid', 'is-invalid');
    field.removeAttribute('aria-invalid');
    
    if (!isEmpty) {
      if (isValid) {
        field.classList.add('is-valid');
        field.setAttribute('aria-invalid', 'false');
      } else {
        field.classList.add('is-invalid');
        field.setAttribute('aria-invalid', 'true');
      }
    }
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    updateSubmitButton();
  }
  
  // é€ä¿¡ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
  function updateSubmitButton() {
    const passcodeValue = passcodeField ? passcodeField.value : '';
    const isValidPasscode = /^[0-9]{6}$/.test(passcodeValue);
    
    if (submitButton) {
      submitButton.disabled = !isValidPasscode;
    }
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®è¿½åŠ å‡¦ç†
  if (form) {
    form.addEventListener('submit', function(e) {
      const emailField = form.querySelector('input[name="temp_password_verification[email]"]');
      const email = emailField ? emailField.value.trim() : '';
      const passcode = passcodeField ? passcodeField.value.trim() : '';
      
      // åŸºæœ¬çš„ãªæ¤œè¨¼
      if (!email) {
        e.preventDefault();
        showError('ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
        setTimeout(() => {
          window.location.href = '<%= new_store_user_session_path(store_slug: @store.slug) %>';
        }, 2000);
        return false;
      }
      
      if (passcode.length !== 6 || !/^[0-9]{6}$/.test(passcode)) {
        e.preventDefault();
        showError('6æ¡ã®æ•°å­—ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        passcodeField.focus();
        return false;
      }
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¨­å®š
      setLoadingState(true);
    });
  }
  
  // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•°
  function showError(message) {
    // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    const existingAlert = document.querySelector('.alert-danger');
    if (existingAlert) {
      existingAlert.remove();
    }
    
    // æ–°ã—ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.setAttribute('role', 'alert');
    alert.innerHTML = `
      <i class="bi bi-exclamation-triangle me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="é–‰ã˜ã‚‹"></button>
    `;
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã®å‰ã«æŒ¿å…¥
    form.insertBefore(alert, form.firstChild);
    
    // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    alert.focus();
  }
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¨­å®š
  function setLoadingState(isLoading) {
    if (submitButton) {
      if (isLoading) {
        submitButton.disabled = true;
        submitButton.classList.add('loading');
        const originalText = submitButton.textContent;
        submitButton.setAttribute('data-original-text', originalText);
        submitButton.textContent = submitButton.getAttribute('data-loading-text') || 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
      } else {
        submitButton.disabled = false;
        submitButton.classList.remove('loading');
        const originalText = submitButton.getAttribute('data-original-text');
        if (originalText) {
          submitButton.textContent = originalText;
        }
      }
    }
  }
  
  // åˆæœŸåŒ–æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  updateSubmitButton();
  
  // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
  window.addEventListener('beforeunload', function() {
    setLoadingState(false);
  });
});

// Turboå¯¾å¿œ
document.addEventListener('turbo:load', function() {
  console.log('ğŸ”„ Turbo load detected for passcode verification page');
});
</script>