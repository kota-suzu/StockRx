<% content_for :title, "パスコード入力" %>

<style>
  /* モダンなグラデーション背景 */
  .gradient-bg {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  /* カード影効果 */
  .card-shadow {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }
  
  /* パスコード入力フィールド */
  .passcode-input {
    font-size: 2rem;
    letter-spacing: 1rem;
    text-align: center;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
  }
  
  /* アニメーション */
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-slide-up {
    animation: slideUp 0.5s ease-out;
  }
  
  /* フォーカス時のグロー効果 */
  .glow-focus:focus {
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.4);
  }
</style>

<div class="min-h-screen gradient-bg flex items-center justify-center px-4 py-12">
  <div class="max-w-md w-full animate-slide-up">
    
    <!-- ロゴとタイトル -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-20 h-20 bg-white rounded-full shadow-lg mb-4">
        <i class="bi bi-shield-lock text-3xl text-purple-600"></i>
      </div>
      <h1 class="text-3xl font-bold text-white mb-2">StockRx</h1>
      <p class="text-purple-200"><%= @store.name %></p>
    </div>

    <!-- メインカード -->
    <div class="bg-white rounded-2xl card-shadow p-8">
      
      <!-- ヘッダー -->
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
          <i class="bi bi-envelope-check text-2xl text-green-600"></i>
        </div>
        <h2 class="text-2xl font-semibold text-gray-800 mb-2">パスコードを入力</h2>
        <p class="text-gray-600">メールで受信した6桁のパスコードを入力してください</p>
      </div>

      <!-- フォーム -->
      <%= form_with model: @temp_password_verification,
                    url: store_verify_temp_password_path(store_slug: @store.slug),
                    local: true,
                    id: "passcode-verify-form",
                    class: "space-y-6" do |form| %>
        
        <!-- メールアドレス表示 -->
        <div class="bg-gray-50 rounded-lg p-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            <i class="bi bi-envelope"></i>
            送信先メールアドレス
          </label>
          <p class="text-gray-900 font-medium"><%= @masked_email %></p>
          <%= form.hidden_field :email, value: @temp_password_verification.email %>
        </div>

        <!-- パスコード入力 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <i class="bi bi-shield-lock"></i>
            6桁のパスコード
          </label>
          <%= form.text_field :temp_password,
                              placeholder: "······",
                              required: true,
                              autocomplete: "one-time-code",
                              maxlength: 6,
                              pattern: "[0-9]{6}",
                              inputmode: "numeric",
                              id: "temp_password_field",
                              class: "w-full px-4 py-4 rounded-lg border-2 border-gray-300 focus:border-purple-500 focus:outline-none glow-focus transition-all duration-200 passcode-input" %>
          <p class="mt-2 text-xs text-gray-500">
            <i class="bi bi-info-circle"></i>
            パスコードは15分間有効です
          </p>
        </div>

        <!-- 隠しフィールド -->
        <%= form.hidden_field :store_id, value: @store.id %>
        <%= form.hidden_field :store_slug, value: @store.slug %>

        <!-- ログインボタン -->
        <div>
          <%= form.submit "ログイン",
                          id: "submit-passcode",
                          class: "w-full bg-gradient-to-r from-green-600 to-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:from-green-700 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-200 cursor-pointer" %>
        </div>

        <!-- リンク -->
        <div class="flex items-center justify-between text-sm">
          <%= link_to new_store_user_session_path(store_slug: @store.slug),
                      class: "text-purple-600 hover:text-purple-700 font-medium" do %>
            <i class="bi bi-arrow-left"></i>
            パスコードを再送信
          <% end %>
          <%= link_to store_selection_path,
                      class: "text-gray-600 hover:text-gray-700" do %>
            <i class="bi bi-shop"></i>
            別の店舗を選択
          <% end %>
        </div>
      <% end %>

      <!-- セキュリティ情報 -->
      <div class="mt-6 p-4 bg-amber-50 rounded-lg border border-amber-200">
        <div class="flex">
          <div class="flex-shrink-0">
            <i class="bi bi-shield-exclamation text-amber-600 text-xl"></i>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-amber-800">セキュリティ情報</h3>
            <div class="mt-1 text-sm text-amber-700">
              <ul class="list-disc list-inside space-y-1">
                <li>パスコードは1回限り使用可能です</li>
                <li>5回間違えるとロックされます</li>
                <li>不審なアクセスを検知した場合は管理者にご連絡ください</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
    </div>

    <!-- セキュアな接続表示 -->
    <div class="mt-8 text-center">
      <div class="inline-flex items-center text-white/80 text-sm">
        <i class="bi bi-shield-check mr-2"></i>
        <span>安全な接続で保護されています</span>
      </div>
    </div>
    
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('passcode-verify-form');
  const submitButton = document.getElementById('submit-passcode');
  const passcodeField = document.getElementById('temp_password_field');
  
  // パスコード入力の自動フォーマット
  if (passcodeField) {
    passcodeField.addEventListener('input', function(e) {
      // 数字以外を削除
      this.value = this.value.replace(/[^0-9]/g, '');
      
      // 6桁入力完了時の視覚フィードバック
      if (this.value.length === 6) {
        this.classList.add('border-green-500');
        this.classList.remove('border-gray-300');
      } else {
        this.classList.remove('border-green-500');
        this.classList.add('border-gray-300');
      }
    });
    
    // ペースト時の処理
    passcodeField.addEventListener('paste', function(e) {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      const numbers = pastedText.replace(/[^0-9]/g, '').slice(0, 6);
      this.value = numbers;
      
      // inputイベントをトリガー
      const event = new Event('input', { bubbles: true });
      this.dispatchEvent(event);
    });
    
    // フォーカス時に全選択
    passcodeField.addEventListener('focus', function() {
      this.select();
    });
  }
  
  // フォーム送信時の処理
  if (form) {
    form.addEventListener('submit', function(e) {
      const emailField = form.querySelector('input[name="temp_password_verification[email]"]');
      const email = emailField ? emailField.value.trim() : '';
      const passcode = passcodeField.value.trim();
      
      if (!email) {
        e.preventDefault();
        alert('エラー: メールアドレスが設定されていません。最初からやり直してください。');
        window.location.href = '<%= new_store_user_session_path(store_slug: @store.slug) %>';
        return false;
      }
      
      if (passcode.length !== 6) {
        e.preventDefault();
        alert('6桁のパスコードを入力してください');
        passcodeField.focus();
        return false;
      }
      
      // 送信ボタンを無効化
      submitButton.disabled = true;
      submitButton.value = 'ログイン中...';
      submitButton.classList.add('opacity-70', 'cursor-not-allowed');
    });
  }
});
</script>