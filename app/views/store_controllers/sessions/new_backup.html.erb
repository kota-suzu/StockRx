<% content_for :title, "ãƒ­ã‚°ã‚¤ãƒ³" %>

<h2 class="h4 mb-4 text-center">
  <i class="bi bi-shield-lock me-2"></i>
  åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³
</h2>

<!-- ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å°‚ç”¨èªè¨¼ãƒ•ãƒ­ãƒ¼ -->
<% if @store %>
  <!-- Step 1: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ› -->
  <div id="email-auth-step1">
    <%= form_with url: store_request_temp_password_path(store_slug: @store.slug), local: false, id: "passcode-request-form" do |f| %>
      <div class="mb-3">
        <%= f.label :email, class: "form-label" do %>
          <i class="bi bi-envelope me-1"></i>
          ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        <% end %>
        <%= f.email_field :email, 
                          autofocus: true,
                          autocomplete: "email",
                          class: "form-control form-control-lg",
                          placeholder: "email@example.com",
                          required: true %>
        <div class="form-text">
          ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
          6æ¡ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã—ã¾ã™ã€‚
        </div>
      </div>

      <div class="d-grid mb-3">
        <%= f.submit "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡", 
                     class: "btn btn-success btn-lg",
                     data: { turbo: false } %>
      </div>
    <% end %>
  </div>

  <!-- Step 2: ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆé€ä¿¡å¾Œã«è¡¨ç¤ºï¼‰ -->
  <div id="email-auth-step2" style="display: none;">
    <%= form_with url: store_verify_temp_password_path(store_slug: @store.slug), local: true, id: "passcode-verify-form" do |f| %>
      <%= f.hidden_field :email, id: "verify-email" %>
      
      <div class="alert alert-success mb-4" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <span id="passcode-sent-message">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</span>
      </div>
      
      <div class="mb-3">
        <%= f.label :temp_password, class: "form-label" do %>
          <i class="bi bi-shield-lock me-1"></i>
          ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰
        <% end %>
        <%= f.text_field :temp_password, 
                         autocomplete: "one-time-code",
                         class: "form-control form-control-lg text-center",
                         placeholder: "123456",
                         maxlength: 6,
                         pattern: "[0-9]{6}",
                         required: true,
                         style: "font-size: 24px; letter-spacing: 8px;" %>
        <div class="form-text">
          ãƒ¡ãƒ¼ãƒ«ã«è¨˜è¼‰ã•ã‚ŒãŸ6æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>

      <div class="d-grid mb-3">
        <%= f.submit "ãƒ­ã‚°ã‚¤ãƒ³", 
                     class: "btn btn-primary btn-lg",
                     data: { turbo: false } %>
      </div>

      <div class="text-center">
        <a href="#" id="resend-passcode" class="text-decoration-none">
          <i class="bi bi-arrow-repeat me-1"></i>
          ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡
        </a>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="alert alert-warning" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<a href="<%= store_selection_path %>">åº—èˆ—ã‚’é¸æŠ</a>ã—ã¦ãã ã•ã„ã€‚
  </div>
<% end %>

<%# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ± %>
<div class="mt-4 p-3 bg-light rounded">
  <h6 class="text-muted mb-2">
    <i class="bi bi-shield-check me-1"></i>
    ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±
  </h6>
  <ul class="small text-muted mb-0">
    <li>ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯15åˆ†é–“æœ‰åŠ¹ã§ã™</li>
    <li>ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯1å›é™ã‚Šä½¿ç”¨å¯èƒ½ã§ã™</li>
    <li>ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„å ´åˆã¯è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã”ç¢ºèªãã ã•ã„</li>
    <li>5å›é€£ç¶šã§å¤±æ•—ã™ã‚‹ã¨ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™</li>
  </ul>
</div>

<script>
// Turboå¯¾å¿œã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰èªè¨¼ãƒ•ãƒ­ãƒ¼
document.addEventListener('turbo:load', function() {
  console.log('ğŸ” Passcode authentication page loaded');
  
  // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ 
  const requestForm = document.getElementById('passcode-request-form');
  if (requestForm) {
    requestForm.addEventListener('submit', function(e) {
      e.preventDefault();
      console.log('ğŸ“§ Requesting passcode...');
      
      const emailInput = requestForm.querySelector('input[type="email"]');
      if (!emailInput) {
        console.error('Email input not found');
        return;
      }
      
      const email = emailInput.value;
      const formData = new FormData(requestForm);
      
      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const submitButton = requestForm.querySelector('input[type="submit"]');
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.value = 'é€ä¿¡ä¸­...';
      }
      
      // Ajaxé€ä¿¡
      fetch(requestForm.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        console.log('Response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          // Step 2ã‚’è¡¨ç¤º
          document.getElementById('email-auth-step1').style.display = 'none';
          document.getElementById('email-auth-step2').style.display = 'block';
          
          // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®š
          document.getElementById('verify-email').value = email;
          
          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
          document.getElementById('passcode-sent-message').innerHTML = 
            `<i class="bi bi-check-circle me-2"></i>${email} ã«ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚<br>ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚`;
          
          // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
          const passcodeInput = document.querySelector('#email-auth-step2 input[name="temp_password"]');
          if (passcodeInput) {
            passcodeInput.focus();
          }
        } else {
          alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
          // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.value = 'ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡';
          }
        }
      })
      .catch(error => {
        console.error('Fetch error:', error);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.value = 'ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡';
        }
      });
    });
  }
  
  // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å†é€ä¿¡
  const resendLink = document.getElementById('resend-passcode');
  if (resendLink) {
    resendLink.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (confirm('ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
        // Step 1ã«æˆ»ã‚‹
        document.getElementById('email-auth-step1').style.display = 'block';
        document.getElementById('email-auth-step2').style.display = 'none';
        
        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿æŒ
        const email = document.getElementById('verify-email').value;
        const emailInput = document.querySelector('#email-auth-step1 input[type="email"]');
        if (emailInput && email) {
          emailInput.value = email;
        }
      }
    });
  }
  
  // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  const passcodeInput = document.querySelector('input[name="temp_password"]');
  if (passcodeInput) {
    passcodeInput.addEventListener('input', function(e) {
      // æ•°å­—ä»¥å¤–ã‚’å‰Šé™¤
      this.value = this.value.replace(/[^0-9]/g, '');
    });
  }
});

// TODO: ğŸŸ¡ Phase 3ï¼ˆæ¨å¥¨ï¼‰- UXæ”¹å–„
// - ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›æ™‚ã®è‡ªå‹•é€ä¿¡ï¼ˆ6æ¡å…¥åŠ›å®Œäº†æ™‚ï¼‰
// - ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºï¼ˆæœ‰åŠ¹æœŸé™ï¼‰
// - ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ†å‰²è¡¨ç¤ºï¼ˆ1æ¡ãšã¤ï¼‰
// æ¨ªå±•é–‹: ä»–ã®èªè¨¼ç”»é¢ã§ã‚‚åŒæ§˜ã®UXæ”¹å–„é©ç”¨
</script>