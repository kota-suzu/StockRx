<% content_for :title, "ãƒ­ã‚°ã‚¤ãƒ³" %>

<h2 class="h4 mb-4 text-center">
  <i class="bi bi-person-lock me-2"></i>
  åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³
</h2>

<!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<ul class="nav nav-tabs mb-4" id="loginTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="nav-link active" id="password-tab" data-bs-toggle="tab" href="#password-login" role="tab" aria-controls="password-login" aria-selected="true">
      <i class="bi bi-key me-1"></i>
      ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³
    </a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" id="email-auth-tab" data-bs-toggle="tab" href="#email-auth-login" role="tab" aria-controls="email-auth-login" aria-selected="false">
      <i class="bi bi-envelope-check me-1"></i>
      ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³
    </a>
  </li>
</ul>

<!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
<div class="tab-content" id="loginTabsContent">
  <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ã‚°ã‚¤ãƒ³ã‚¿ãƒ– -->
  <div class="tab-pane fade show active" id="password-login" role="tabpanel" aria-labelledby="password-tab">
    <%= form_for(resource, as: resource_name, url: session_path(resource_name)) do |f| %>
      <%# åº—èˆ—æƒ…å ±ã‚’éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§é€ä¿¡ %>
      <%= hidden_field_tag :store_slug, @store.slug if @store %>
      
      <%# ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ %>
      <div class="mb-3">
        <%= f.label :email, class: "form-label" do %>
          <i class="bi bi-envelope me-1"></i>
          ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        <% end %>
        <%= f.email_field :email, 
                          autofocus: true, 
                          autocomplete: "email",
                          class: "form-control form-control-lg",
                          placeholder: "email@example.com",
                          required: true %>
      </div>

      <%# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ %>
      <div class="mb-3">
        <%= f.label :password, class: "form-label" do %>
          <i class="bi bi-key me-1"></i>
          ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        <% end %>
        <%= f.password_field :password, 
                            autocomplete: "current-password",
                            class: "form-control form-control-lg",
                            placeholder: "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",
                            required: true %>
      </div>

      <%# ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’è¨˜æ†¶ %>
      <% if devise_mapping.rememberable? %>
        <div class="mb-3">
          <div class="form-check">
            <%= f.check_box :remember_me, class: "form-check-input" %>
            <%= f.label :remember_me, class: "form-check-label" do %>
              ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’è¨˜æ†¶ã™ã‚‹
            <% end %>
          </div>
        </div>
      <% end %>

      <%# ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ %>
      <div class="d-grid mb-3">
        <%= f.submit "ãƒ­ã‚°ã‚¤ãƒ³", 
                     class: "btn btn-primary btn-lg",
                     data: { turbo: false } %>
      </div>

      <%# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ %>
      <div class="text-center">
        <% if @store %>
          <%= link_to new_store_user_password_path(store_slug: @store.slug), 
                      class: "text-decoration-none" do %>
            <i class="bi bi-question-circle me-1"></i>
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹ã¯ã“ã¡ã‚‰
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ã‚°ã‚¤ãƒ³ã‚¿ãƒ– -->
  <div class="tab-pane fade" id="email-auth-login" role="tabpanel" aria-labelledby="email-auth-tab">
    <% if @store %>
      <%= form_with url: store_request_temp_password_path(store_slug: @store.slug), local: true do |f| %>
      <!-- Step 1: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ› -->
      <div id="email-auth-step1">
        <div class="mb-3">
          <%= f.label :email, class: "form-label" do %>
            <i class="bi bi-envelope me-1"></i>
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
          <% end %>
          <%= f.email_field :email, 
                            autocomplete: "email",
                            class: "form-control form-control-lg",
                            placeholder: "email@example.com",
                            required: true %>
          <div class="form-text">
            ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
            ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã—ã¾ã™ã€‚
          </div>
        </div>

        <div class="d-grid mb-3">
          <%= f.submit "ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡", 
                       class: "btn btn-success btn-lg",
                       data: { turbo: false } %>
        </div>
      </div>
    <% end %>

    <!-- Step 2: ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆé€ä¿¡å¾Œã«è¡¨ç¤ºï¼‰ -->
    <div id="email-auth-step2" style="display: none;">
      <% if @store %>
        <%= form_with url: store_verify_temp_password_path(store_slug: @store.slug), local: true do |f| %>
        <%= f.hidden_field :email, id: "verify-email" %>
        
        <div class="alert alert-success" role="alert">
          <i class="bi bi-check-circle me-2"></i>
          ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
        </div>
        
        <div class="mb-3">
          <%= f.label :temp_password, class: "form-label" do %>
            <i class="bi bi-shield-lock me-1"></i>
            ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          <% end %>
          <%= f.text_field :temp_password, 
                           autocomplete: "one-time-code",
                           class: "form-control form-control-lg",
                           placeholder: "123456",
                           maxlength: 6,
                           pattern: "[0-9]{6}",
                           required: true %>
          <div class="form-text">
            ãƒ¡ãƒ¼ãƒ«ã«è¨˜è¼‰ã•ã‚ŒãŸ6æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
          </div>
        </div>

        <div class="d-grid mb-3">
          <%= f.submit "ãƒ­ã‚°ã‚¤ãƒ³", 
                       class: "btn btn-primary btn-lg",
                       data: { turbo: false } %>
        </div>

        <div class="text-center">
          <a href="#" id="resend-temp-password" class="text-decoration-none">
            <i class="bi bi-arrow-repeat me-1"></i>
            ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†é€ä¿¡
          </a>
        </div>
        <% end %>
      <% end %>
    </div>
    <% else %>
      <div class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<a href="<%= store_selection_path %>">åº—èˆ—ã‚’é¸æŠ</a>ã—ã¦ãã ã•ã„ã€‚
      </div>
    <% end %>
  </div>
</div>

<%# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ± %>
<div class="mt-4 p-3 bg-light rounded">
  <h6 class="text-muted mb-2">
    <i class="bi bi-shield-check me-1"></i>
    ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±
  </h6>
  <div id="password-security-info">
    <ul class="small text-muted mb-0">
      <li>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯12æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„</li>
      <li>å¤§æ–‡å­—ãƒ»å°æ–‡å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ã‚’å«ã‚ã¦ãã ã•ã„</li>
      <li>5å›é€£ç¶šã§å¤±æ•—ã™ã‚‹ã¨30åˆ†é–“ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™</li>
      <li>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯90æ—¥ã”ã¨ã«å¤‰æ›´ãŒå¿…è¦ã§ã™</li>
    </ul>
  </div>
  <div id="temp-password-security-info" style="display: none;">
    <ul class="small text-muted mb-0">
      <li>ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯15åˆ†é–“æœ‰åŠ¹ã§ã™</li>
      <li>ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯1å›é™ã‚Šä½¿ç”¨å¯èƒ½ã§ã™</li>
      <li>ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„å ´åˆã¯è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã”ç¢ºèªãã ã•ã„</li>
      <li>5å›é€£ç¶šã§å¤±æ•—ã™ã‚‹ã¨ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™</li>
    </ul>
  </div>
</div>

<script>
// Turboã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦BootstrapåˆæœŸåŒ–ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’èª¿æ•´
// CLAUDE.mdæº–æ‹ : Turboå¯¾å¿œã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹å®Ÿè£…
document.addEventListener('turbo:load', function() {
  console.log('Store login page loaded (turbo:load)');
  
  // ğŸ”§ Bootstrap ã‚¿ãƒ–ã®åˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
  function initializeBootstrapTabs() {
    console.log('ğŸ”§ Checking Bootstrap availability...');
    
    if (typeof bootstrap === 'undefined') {
      console.warn('âš ï¸ Bootstrap not yet available, retrying...');
      setTimeout(initializeBootstrapTabs, 100);
      return;
    }
    
    console.log('âœ… Bootstrap is available');
    
    const triggerTabList = document.querySelectorAll('#loginTabs a[data-bs-toggle="tab"]');
    if (triggerTabList.length > 0) {
      console.log(`ğŸ”§ Initializing ${triggerTabList.length} Bootstrap tabs...`);
      
      triggerTabList.forEach((triggerEl, index) => {
        try {
          // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
          const existingTab = bootstrap.Tab.getInstance(triggerEl);
          if (existingTab) {
            existingTab.dispose();
          }
          
          // æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
          const tabTrigger = new bootstrap.Tab(triggerEl);
          console.log(`âœ… Tab ${index + 1} initialized: ${triggerEl.id}`);
          
          // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½åŠ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            console.log(`Tab clicked: ${this.id}`);
            tabTrigger.show();
          });
        } catch (error) {
          console.error(`âŒ Failed to initialize tab ${index + 1}:`, error);
          
          // æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          triggerEl.addEventListener('click', function(event) {
            event.preventDefault();
            console.log(`Manual tab switch: ${this.id}`);
            
            // å…¨ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('#loginTabs .nav-link').forEach(link => {
              link.classList.remove('active');
              link.setAttribute('aria-selected', 'false');
            });
            
            // å…¨ã¦ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«
            document.querySelectorAll('#loginTabsContent .tab-pane').forEach(pane => {
              pane.classList.remove('show', 'active');
            });
            
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            this.classList.add('active');
            this.setAttribute('aria-selected', 'true');
            
            // å¯¾å¿œã™ã‚‹ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
            const targetId = this.getAttribute('href');
            const targetPane = document.querySelector(targetId);
            if (targetPane) {
              targetPane.classList.add('show', 'active');
            }
          });
        }
      });
    } else {
      console.error('âŒ No Bootstrap tab triggers found');
    }
  }
  
  // åˆæœŸåŒ–ã‚’é–‹å§‹
  initializeBootstrapTabs();
  
  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±ã®æ›´æ–°
  const passwordTab = document.getElementById('password-tab');
  const emailAuthTab = document.getElementById('email-auth-tab');
  const passwordInfo = document.getElementById('password-security-info');
  const tempPasswordInfo = document.getElementById('temp-password-security-info');
  
  if (passwordTab && emailAuthTab && passwordInfo && tempPasswordInfo) {
    // Bootstrap ã‚¿ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆshown.bs.tabï¼‰ã‚’ä½¿ç”¨
    passwordTab.addEventListener('shown.bs.tab', function() {
      console.log('Password tab shown');
      passwordInfo.style.display = 'block';
      tempPasswordInfo.style.display = 'none';
    });
    
    emailAuthTab.addEventListener('shown.bs.tab', function() {
      console.log('Email auth tab shown');
      passwordInfo.style.display = 'none';
      tempPasswordInfo.style.display = 'block';
    });
  } else {
    console.error('Tab elements not found:', {
      passwordTab: !!passwordTab,
      emailAuthTab: !!emailAuthTab,
      passwordInfo: !!passwordInfo,
      tempPasswordInfo: !!tempPasswordInfo
    });
  }
  
  // ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é€ä¿¡å¾Œã®UIåˆ‡ã‚Šæ›¿ãˆ
  const emailAuthForm = document.querySelector('#email-auth-step1 form');
  if (emailAuthForm) {
    console.log('Email auth form found:', emailAuthForm.action);
    
    emailAuthForm.addEventListener('submit', function(e) {
      e.preventDefault();
      console.log('Form submit prevented');
      
      const emailInput = emailAuthForm.querySelector('input[type="email"]');
      if (!emailInput) {
        console.error('Email input not found');
        alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      
      const email = emailInput.value;
      console.log('Email:', email);
      
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
      const formData = new FormData(emailAuthForm);
      
      // Ajaxé€ä¿¡
      console.log('Sending request to:', emailAuthForm.action);
      fetch(emailAuthForm.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        }
      })
      .then(response => {
        console.log('Response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          // Step 2ã‚’è¡¨ç¤º
          document.getElementById('email-auth-step1').style.display = 'none';
          document.getElementById('email-auth-step2').style.display = 'block';
          
          const verifyEmailInput = document.getElementById('verify-email');
          if (verifyEmailInput) {
            verifyEmailInput.value = email;
          }
          
          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
          const alertDiv = document.querySelector('#email-auth-step2 .alert');
          if (alertDiv) {
            alertDiv.innerHTML = `
              <i class="bi bi-check-circle me-2"></i>
              ${email} ã«ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚<br>
              ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
            `;
          }
        } else {
          // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
          alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        }
      })
      .catch(error => {
        console.error('Fetch error:', error);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      });
    });
  } else {
    console.log('Email auth form not found - store might not be selected');
  }
  
  // å†é€ä¿¡ãƒªãƒ³ã‚¯
  const resendLink = document.getElementById('resend-temp-password');
  if (resendLink) {
    resendLink.addEventListener('click', function(e) {
      e.preventDefault();
      const email = document.getElementById('verify-email').value;
      
      // å†é€ä¿¡å‡¦ç†
      if (confirm('ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
        // Step 1ã«æˆ»ã‚‹
        document.getElementById('email-auth-step1').style.display = 'block';
        document.getElementById('email-auth-step2').style.display = 'none';
        document.querySelector('#email-auth-step1 input[type="email"]').value = email;
      }
    });
  }
});
</script>