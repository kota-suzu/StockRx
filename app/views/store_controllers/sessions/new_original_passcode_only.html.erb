<% content_for :title, "ãƒ­ã‚°ã‚¤ãƒ³" %>

<style>
  /* ãƒ¢ãƒ€ãƒ³ãªã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ */
  .gradient-bg {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  /* ã‚«ãƒ¼ãƒ‰å½±åŠ¹æœ */
  .card-shadow {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }
  
  /* ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
  .passcode-input {
    font-size: 2rem;
    letter-spacing: 1rem;
    text-align: center;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
  }
  
  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-slide-up {
    animation: slideUp 0.5s ease-out;
  }
  
  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
  .spinner {
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 3px solid white;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ã‚°ãƒ­ãƒ¼åŠ¹æœ */
  .glow-focus:focus {
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.4);
  }
</style>

<div class="min-h-screen gradient-bg flex items-center justify-center px-4 py-12">
  <div class="max-w-md w-full animate-slide-up">
    <!-- ãƒ­ã‚´ã¨ã‚¿ã‚¤ãƒˆãƒ« -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-20 h-20 bg-white rounded-full shadow-lg mb-4">
        <i class="bi bi-shield-lock text-3xl text-purple-600"></i>
      </div>
      <h1 class="text-3xl font-bold text-white mb-2">StockRx</h1>
      <p class="text-purple-200"><%= @store ? @store.name : "åº—èˆ—ãƒ­ã‚°ã‚¤ãƒ³" %></p>
    </div>

    <% if @store %>
      <!-- ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
      <div class="bg-white rounded-2xl card-shadow p-8">
        <!-- Step 1: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ› -->
        <div id="email-auth-step1">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <p class="text-gray-600">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã‚‹</p>
          </div>

          <%= form_with url: store_request_temp_password_path(store_slug: @store.slug), 
                        local: false, 
                        id: "passcode-request-form",
                        class: "space-y-6" do |f| %>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
              </label>
              <%= f.email_field :email, 
                                autofocus: true,
                                autocomplete: "email",
                                class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-purple-500 focus:outline-none glow-focus transition-all duration-200",
                                placeholder: "email@example.com",
                                required: true %>
            </div>

            <div>
              <%= f.submit "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡", 
                           id: "submit-email",
                           class: "w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all duration-200 cursor-pointer" %>
            </div>
          <% end %>

          <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
              <i class="bi bi-info-circle"></i>
              6æ¡ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã•ã‚Œã¾ã™
            </p>
          </div>
        </div>

        <!-- Step 2: ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ› -->
        <div id="email-auth-step2" style="display: none;">
          <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
              <i class="bi bi-envelope-check text-2xl text-green-600"></i>
            </div>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</h2>
            <p class="text-gray-600" id="passcode-sent-message">
              ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ
            </p>
          </div>

          <%= form_with url: store_verify_temp_password_path(store_slug: @store.slug), 
                        local: true, 
                        id: "passcode-verify-form",
                        class: "space-y-6" do |f| %>
            <%= f.hidden_field :email, id: "verify-email" %>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                6æ¡ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰
              </label>
              <%= f.text_field :temp_password, 
                               autocomplete: "one-time-code",
                               class: "w-full px-4 py-4 rounded-lg border-2 border-gray-300 focus:border-purple-500 focus:outline-none glow-focus transition-all duration-200 passcode-input",
                               placeholder: "Â·Â·Â·Â·Â·Â·",
                               maxlength: 6,
                               pattern: "[0-9]{6}",
                               inputmode: "numeric",
                               required: true %>
            </div>

            <div>
              <%= f.submit "ãƒ­ã‚°ã‚¤ãƒ³", 
                           id: "submit-passcode",
                           class: "w-full bg-gradient-to-r from-green-600 to-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:from-green-700 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-200 cursor-pointer" %>
            </div>
          <% end %>

          <div class="mt-6 text-center">
            <button id="resend-passcode" class="text-purple-600 hover:text-purple-700 font-medium text-sm">
              <i class="bi bi-arrow-repeat"></i>
              ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡
            </button>
          </div>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ -->
        <div id="loading-state" style="display: none;">
          <div class="text-center py-12">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">å‡¦ç†ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ± -->
      <div class="mt-8 text-center">
        <div class="inline-flex items-center text-white/80 text-sm">
          <i class="bi bi-shield-check mr-2"></i>
          <span>å®‰å…¨ãªæ¥ç¶šã§ä¿è­·ã•ã‚Œã¦ã„ã¾ã™</span>
        </div>
      </div>
    <% else %>
      <!-- åº—èˆ—æœªé¸æŠ -->
      <div class="bg-white rounded-2xl card-shadow p-8">
        <div class="text-center">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-yellow-100 rounded-full mb-4">
            <i class="bi bi-exclamation-triangle text-2xl text-yellow-600"></i>
          </div>
          <h2 class="text-xl font-semibold text-gray-800 mb-2">åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</h2>
          <p class="text-gray-600 mb-6">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
          <%= link_to store_selection_path, 
                      class: "inline-flex items-center px-6 py-3 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-colors duration-200" do %>
            <i class="bi bi-shop mr-2"></i>
            åº—èˆ—ã‚’é¸æŠ
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener('turbo:load', function() {
  console.log('ğŸ¨ Modern passcode authentication loaded');
  
  const step1 = document.getElementById('email-auth-step1');
  const step2 = document.getElementById('email-auth-step2');
  const loadingState = document.getElementById('loading-state');
  const requestForm = document.getElementById('passcode-request-form');
  const passcodeInput = document.querySelector('input[name="temp_password"]');
  
  // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ 
  if (requestForm) {
    requestForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const emailInput = requestForm.querySelector('input[type="email"]');
      const submitButton = document.getElementById('submit-email');
      const originalText = submitButton.value;
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
      submitButton.value = 'é€ä¿¡ä¸­...';
      submitButton.disabled = true;
      submitButton.classList.add('opacity-70', 'cursor-not-allowed');
      
      const formData = new FormData(requestForm);
      
      fetch(requestForm.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Step 2ã«é·ç§»
          step1.style.display = 'none';
          step2.style.display = 'block';
          step2.classList.add('animate-slide-up');
          
          // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¨­å®š
          document.getElementById('verify-email').value = emailInput.value;
          document.getElementById('passcode-sent-message').innerHTML = 
            `<i class="bi bi-check-circle text-green-600"></i> ${emailInput.value} ã«é€ä¿¡ã—ã¾ã—ãŸ`;
          
          // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
          if (passcodeInput) {
            passcodeInput.focus();
          }
        } else {
          alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          submitButton.value = originalText;
          submitButton.disabled = false;
          submitButton.classList.remove('opacity-70', 'cursor-not-allowed');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        submitButton.value = originalText;
        submitButton.disabled = false;
        submitButton.classList.remove('opacity-70', 'cursor-not-allowed');
      });
    });
  }
  
  // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  if (passcodeInput) {
    passcodeInput.addEventListener('input', function(e) {
      // æ•°å­—ä»¥å¤–ã‚’å‰Šé™¤
      this.value = this.value.replace(/[^0-9]/g, '');
      
      // 6æ¡å…¥åŠ›å®Œäº†æ™‚ã®è‡ªå‹•é€ä¿¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      if (this.value.length === 6) {
        // è‡ªå‹•é€ä¿¡ã‚’æœ‰åŠ¹ã«ã™ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤
        // document.getElementById('passcode-verify-form').submit();
      }
    });
    
    // ãƒšãƒ¼ã‚¹ãƒˆæ™‚ã®å‡¦ç†
    passcodeInput.addEventListener('paste', function(e) {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      const numbers = pastedText.replace(/[^0-9]/g, '').slice(0, 6);
      this.value = numbers;
    });
  }
  
  // å†é€ä¿¡ãƒœã‚¿ãƒ³
  const resendButton = document.getElementById('resend-passcode');
  if (resendButton) {
    resendButton.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (confirm('ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
        // Step 1ã«æˆ»ã‚‹
        step2.style.display = 'none';
        step1.style.display = 'block';
        step1.classList.add('animate-slide-up');
        
        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿æŒ
        const email = document.getElementById('verify-email').value;
        const emailInput = document.querySelector('#email-auth-step1 input[type="email"]');
        if (emailInput && email) {
          emailInput.value = email;
        }
      }
    });
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  const verifyForm = document.getElementById('passcode-verify-form');
  if (verifyForm) {
    verifyForm.addEventListener('submit', function() {
      const submitButton = document.getElementById('submit-passcode');
      submitButton.value = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
      submitButton.disabled = true;
      submitButton.classList.add('opacity-70', 'cursor-not-allowed');
    });
  }
});
</script>