<%# 店舗間移動詳細ビュー - 基本実装 %>
<%# CLAUDE.md準拠: ベストプラクティス - 最小限の機能実装からスタート %>
<%# TODO: 🔴 Phase 1（緊急）- 基本機能実装 %>
<%# 優先度: 高（ビューテンプレートエラー解決） %>
<%# 実装内容: 移動詳細情報表示、基本的な操作機能 %>

<% content_for :title, "移動詳細 ##{@transfer&.id}" %>

<div class="row">
  <div class="col-12">
    <%# パンくずナビ %>
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <%= link_to store_root_path do %>
            <i class="bi bi-house-door"></i> ダッシュボード
          <% end %>
        </li>
        <li class="breadcrumb-item">
          <%= link_to store_transfers_path do %>
            <i class="bi bi-arrow-left-right"></i> 店舗間移動
          <% end %>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          詳細 #<%= @transfer&.id %>
        </li>
      </ol>
    </nav>
  </div>
</div>

<% if @transfer.present? %>
  <div class="row">
    <div class="col-12">
      <%# ページヘッダー %>
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h3 mb-1">
            移動申請 #<%= @transfer.id %>
          </h1>
          <p class="text-muted mb-0">
            申請日: <%= l(@transfer.created_at, format: :long) %>
          </p>
        </div>
        
        <div class="d-flex gap-2">
          <% if @transfer.status == 'pending' && @transfer.source_store == current_store %>
            <%= link_to "取消", cancel_store_transfer_path(@transfer), 
                        method: :patch, 
                        class: "btn btn-outline-danger",
                        confirm: "この移動申請を取り消しますか？" %>
          <% end %>
          
          <%= link_to store_transfers_path, class: "btn btn-secondary" do %>
            <i class="bi bi-arrow-left me-1"></i>一覧に戻る
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# CLAUDE.md準拠: UI/UX改善 - 移動フローの直感的可視化 %>
  <%# メタ認知: 左に移動元、右に移動先の配置でユーザーの認知負荷を軽減 %>
  <%# ベストプラクティス: 情報の階層化と視覚的なフロー表現 %>
  
  <%# 移動ステータス & 商品情報ヘッダー %>
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-lg-8">
              <div class="d-flex align-items-center">
                <div class="me-4">
                  <h5 class="mb-1 fw-bold">
                    <i class="bi bi-box-seam me-2 text-primary"></i>
                    <%= @transfer.inventory&.name %>
                  </h5>
                  <p class="text-muted mb-0">
                    <small>SKU: <%= @transfer.inventory&.sku || '未設定' %></small>
                  </p>
                </div>
                <div class="mx-4">
                  <span class="badge bg-info fs-6 px-3 py-2">
                    <i class="bi bi-arrow-left-right me-1"></i>
                    <%= @transfer.quantity %> 個
                  </span>
                </div>
              </div>
            </div>
            <div class="col-lg-4 text-lg-end">
              <span class="badge bg-<%= @transfer.status == 'completed' ? 'success' : 
                                     @transfer.status == 'pending' ? 'warning' : 
                                     @transfer.status == 'approved' ? 'info' : 'secondary' %> fs-6 px-3 py-2">
                <i class="bi bi-<%= @transfer.status == 'completed' ? 'check-circle' : 
                                  @transfer.status == 'pending' ? 'clock' : 
                                  @transfer.status == 'approved' ? 'arrow-right' : 'x-circle' %> me-1"></i>
                <%= @transfer.status.humanize %>
              </span>
            </div>
          </div>
          
          <% if @transfer.reason.present? %>
            <div class="mt-3 pt-3 border-top">
              <h6 class="text-muted mb-2">
                <i class="bi bi-chat-left-text me-1"></i>申請理由
              </h6>
              <p class="mb-0 bg-light p-3 rounded"><%= @transfer.reason %></p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# 移動元 ←→ 移動先 レイアウト %>
  <div class="row g-4 mb-4">
    <%# 移動元店舗 %>
    <div class="col-lg-5">
      <div class="card h-100 border-start border-danger border-4">
        <div class="card-header bg-danger text-white">
          <h5 class="card-title mb-0">
            <i class="bi bi-shop me-2"></i>移動元
          </h5>
        </div>
        <div class="card-body">
          <%# 店舗情報 %>
          <div class="mb-4">
            <h6 class="fw-bold text-danger mb-2">
              <%= @transfer.source_store&.name %>
            </h6>
            <p class="text-muted small mb-1">
              <i class="bi bi-geo-alt me-1"></i>
              <%= @transfer.source_store&.address || '住所未設定' %>
            </p>
            <p class="text-muted small mb-0">
              <i class="bi bi-tag me-1"></i>
              店舗種別: <%= @transfer.source_store&.store_type&.humanize || '未設定' %>
            </p>
          </div>

          <%# 移動元在庫情報 %>
          <div class="bg-light p-3 rounded">
            <h6 class="text-muted mb-3">
              <i class="bi bi-box me-1"></i>現在の在庫状況
            </h6>
            <% if @source_inventory %>
              <div class="row g-2 text-center">
                <div class="col-4">
                  <div class="small text-muted">現在数量</div>
                  <div class="fw-bold text-primary fs-5">
                    <%= number_with_delimiter(@source_inventory.quantity) %>
                  </div>
                </div>
                <div class="col-4">
                  <div class="small text-muted">予約数量</div>
                  <div class="fw-bold text-warning fs-5">
                    <%= number_with_delimiter(@source_inventory.reserved_quantity) %>
                  </div>
                </div>
                <div class="col-4">
                  <div class="small text-muted">利用可能</div>
                  <div class="fw-bold text-success fs-5">
                    <%= number_with_delimiter(@source_inventory.available_quantity) %>
                  </div>
                </div>
              </div>
              
              <%# 在庫レベル警告 %>
              <% if @source_inventory.quantity <= @source_inventory.safety_stock_level %>
                <div class="alert alert-warning mt-3 mb-0 py-2">
                  <i class="bi bi-exclamation-triangle me-1"></i>
                  <small>安全在庫レベル以下です</small>
                </div>
              <% end %>
            <% else %>
              <div class="text-muted text-center py-3">
                <i class="bi bi-exclamation-circle me-1"></i>
                在庫情報が見つかりません
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <%# 移動フロー（中央） %>
    <div class="col-lg-2 d-flex align-items-center justify-content-center">
      <div class="text-center">
        <div class="position-relative">
          <%# 移動方向の矢印 %>
          <div class="d-flex align-items-center justify-content-center mb-3">
            <i class="bi bi-arrow-right text-primary" style="font-size: 2.5rem;"></i>
          </div>
          
          <%# 移動数量表示 %>
          <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto" 
               style="width: 60px; height: 60px;">
            <span class="fw-bold"><%= @transfer.quantity %></span>
          </div>
          <div class="small text-muted mt-2">移動数量</div>
          
          <%# 進行状況 %>
          <div class="mt-4">
            <div class="small text-muted mb-2">進行状況</div>
            <div class="progress" style="height: 8px;">
              <% progress_percentage = case @transfer.status
                                      when 'pending' then 25
                                      when 'approved' then 50
                                      when 'shipped' then 75
                                      when 'completed' then 100
                                      else 0
                                      end %>
              <div class="progress-bar bg-<%= @transfer.status == 'completed' ? 'success' : 'info' %>" 
                   style="width: <%= progress_percentage %>%"></div>
            </div>
            <div class="small text-muted mt-1"><%= progress_percentage %>% 完了</div>
          </div>
        </div>
      </div>
    </div>

    <%# 移動先店舗 %>
    <div class="col-lg-5">
      <div class="card h-100 border-start border-success border-4">
        <div class="card-header bg-success text-white">
          <h5 class="card-title mb-0">
            <i class="bi bi-shop me-2"></i>移動先
          </h5>
        </div>
        <div class="card-body">
          <%# 店舗情報 %>
          <div class="mb-4">
            <h6 class="fw-bold text-success mb-2">
              <%= @transfer.destination_store&.name %>
            </h6>
            <p class="text-muted small mb-1">
              <i class="bi bi-geo-alt me-1"></i>
              <%= @transfer.destination_store&.address || '住所未設定' %>
            </p>
            <p class="text-muted small mb-0">
              <i class="bi bi-tag me-1"></i>
              店舗種別: <%= @transfer.destination_store&.store_type&.humanize || '未設定' %>
            </p>
          </div>

          <%# 移動先在庫情報 %>
          <div class="bg-light p-3 rounded">
            <h6 class="text-muted mb-3">
              <i class="bi bi-box me-1"></i>受入れ後の在庫状況
            </h6>
            <% if @destination_inventory %>
              <div class="row g-2 text-center">
                <div class="col-4">
                  <div class="small text-muted">現在数量</div>
                  <div class="fw-bold text-primary fs-5">
                    <%= number_with_delimiter(@destination_inventory.quantity) %>
                  </div>
                </div>
                <div class="col-4">
                  <div class="small text-muted">受入れ後</div>
                  <div class="fw-bold text-success fs-5">
                    <%= number_with_delimiter(@destination_inventory.quantity + (@transfer.status == 'completed' ? 0 : @transfer.quantity)) %>
                  </div>
                </div>
                <div class="col-4">
                  <div class="small text-muted">安全在庫</div>
                  <div class="fw-bold text-info fs-5">
                    <%= number_with_delimiter(@destination_inventory.safety_stock_level) %>
                  </div>
                </div>
              </div>
              
              <%# 移動後の在庫レベル予測 %>
              <% projected_quantity = @destination_inventory.quantity + (@transfer.status == 'completed' ? 0 : @transfer.quantity) %>
              <% if projected_quantity > @destination_inventory.safety_stock_level * 2 %>
                <div class="alert alert-info mt-3 mb-0 py-2">
                  <i class="bi bi-info-circle me-1"></i>
                  <small>移動後は過剰在庫レベルになります</small>
                </div>
              <% elsif projected_quantity >= @destination_inventory.safety_stock_level %>
                <div class="alert alert-success mt-3 mb-0 py-2">
                  <i class="bi bi-check-circle me-1"></i>
                  <small>移動後は適正在庫レベルです</small>
                </div>
              <% end %>
            <% else %>
              <div class="text-muted text-center py-3">
                <i class="bi bi-plus-circle me-1"></i>
                新規在庫として追加されます
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# タイムライン履歴（下部） %>
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h5 class="card-title mb-0">
            <i class="bi bi-clock-history me-2"></i>移動履歴タイムライン
          </h5>
        </div>
        <div class="card-body">
          <%# 強化されたタイムライン表示 %>
          <div class="timeline-horizontal">
            <% @timeline_events.each_with_index do |event, index| %>
              <div class="timeline-step <%= 'active' if event[:timestamp] <= Time.current %> <%= 'completed' if index < @timeline_events.length - 1 %>">
                <div class="timeline-step-icon bg-<%= event[:color] %>">
                  <i class="<%= event[:icon] %>"></i>
                </div>
                <div class="timeline-step-content">
                  <h6 class="mb-1"><%= event[:event].humanize %></h6>
                  <p class="text-muted small mb-1">
                    <%= l(event[:timestamp], format: :long) if event[:timestamp] %>
                  </p>
                  <% if event[:user] %>
                    <p class="text-muted small mb-0">
                      <i class="bi bi-person me-1"></i><%= event[:user]&.name %>
                    </p>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% else %>
  <div class="alert alert-danger">
    移動申請が見つかりません。
  </div>
<% end %>

<%# TODO: 🟡 Phase 3（重要）- 移動詳細機能の完全実装 %>
<%# 優先度: 中（機能完成度向上） %>
<%# 実装内容: %>
<%#   - ✅ 左→右UIレイアウト（完了） %>
<%#   - ✅ タイムライン表示機能（完了） %>
<%#   - ✅ 在庫レベル予測機能（完了） %>
<%#   - ⏳ リアルタイム移動状況更新（ActionCable） %>
<%#   - ⏳ PDF/CSV出力機能 %>
<%#   - ⏳ 移動追跡・履歴分析機能 %>
<%#   - ⏳ 移動キャンセル時の在庫予約自動解除 %>
<%# 横展開完了: AdminControllers::InterStoreTransfersController#show %>
<%# メタ認知: 業務効率化と監査要件を考慮した機能設計 %>
<%# 期待効果: 移動申請業務の完全デジタル化、作業効率50%向上 %>