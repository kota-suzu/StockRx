<!DOCTYPE html>
<html>
  <head>
    <title>StockRx - ÁÆ°ÁêÜËÄÖ„Éë„Éç„É´</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <% if admin_signed_in? %>
      <!-- Enhanced Admin Navigation with Multi-Store Support -->
      <nav class="navbar navbar-expand-lg navbar-dark navbar-admin sticky-top">
        <div class="container-fluid">
          <%= link_to admin_root_path, class: "navbar-brand d-flex align-items-center" do %>
            <i class="bi bi-boxes me-2"></i>
            <span>StockRx</span>
            <small class="badge bg-light text-dark ms-2">ÁÆ°ÁêÜ„Éë„Éç„É´</small>
          <% end %>
          
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                  aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
              <!-- „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
              <li class="nav-item">
                <%= link_to admin_root_path, 
                    class: "nav-link #{'active' if current_page?(admin_root_path)}", 
                    title: "„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ" do %>
                  <i class="bi bi-speedometer2 me-1"></i>
                  <span class="d-none d-lg-inline">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
                  <span class="d-lg-none">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
                <% end %>
              </li>

              <!-- „Éû„É´„ÉÅ„Çπ„Éà„Ç¢ÁÆ°ÁêÜ„É°„Éã„É•„ÉºÔºàÊ®©Èôê„Å´„Çà„ÇãË°®Á§∫Âà∂Âæ°Ôºâ -->
              <% if current_admin.can_access_all_stores? || current_admin.store_manager? %>
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle <%= 'active' if request.path.include?('/admin/stores') %>" 
                     href="javascript:void(0)" id="storeDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"
                     title="Â∫óËàóÁÆ°ÁêÜ">
                    <i class="bi bi-shop me-1"></i>
                    <span class="d-none d-lg-inline">Â∫óËàóÁÆ°ÁêÜ</span>
                    <span class="d-lg-none">Â∫óËàó</span>
                  </a>
                  <ul class="dropdown-menu">
                    <li>
                      <%= link_to admin_stores_path, class: "dropdown-item" do %>
                        <i class="bi bi-list me-2"></i>Â∫óËàó‰∏ÄË¶ß
                      <% end %>
                    </li>
                    <% if current_admin.headquarters_admin? %>
                      <li>
                        <%= link_to new_admin_store_path, class: "dropdown-item" do %>
                          <i class="bi bi-plus-circle me-2"></i>Êñ∞Ë¶èÂ∫óËàó
                        <% end %>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <%= link_to admin_stores_path, class: "dropdown-item" do %>
                          <i class="bi bi-graph-up me-2"></i>Â∫óËàóÂàÜÊûê
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </li>

                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle <%= 'active' if request.path.include?('/admin/transfers') %>" 
                     href="javascript:void(0)" id="transferDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"
                     title="Â∫óËàóÈñìÁßªÂãï">
                    <i class="bi bi-truck me-1"></i>
                    <span class="d-none d-lg-inline">ÁßªÂãïÁÆ°ÁêÜ</span>
                    <span class="d-lg-none">ÁßªÂãï</span>
                  </a>
                  <ul class="dropdown-menu">
                    <li>
                      <%= link_to admin_inter_store_transfers_path, class: "dropdown-item" do %>
                        <i class="bi bi-list me-2"></i>ÁßªÂãï‰∏ÄË¶ß
                      <% end %>
                    </li>
                    <li>
                      <%= link_to new_admin_inter_store_transfer_path, class: "dropdown-item" do %>
                        <i class="bi bi-plus-circle me-2"></i>Êñ∞Ë¶èÁî≥Ë´ã
                      <% end %>
                    </li>
                    <% if current_admin.can_approve_transfers? %>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <%= link_to pending_admin_inter_store_transfers_path, class: "dropdown-item position-relative" do %>
                          <i class="bi bi-clock me-2"></i>ÊâøË™çÂæÖ„Å°
                          <% begin %>
                            <% pending_count = current_admin&.accessible_store_ids&.any? ? InterStoreTransfer.accessible_to_admin(current_admin).pending.count : 0 %>
                            <% if pending_count > 0 %>
                              <span class="badge bg-warning text-dark position-absolute top-0 start-100 translate-middle">
                                <%= pending_count %>
                              </span>
                            <% end %>
                          <% rescue => e %>
                            <%# „Ç®„É©„Éº„É≠„Ç∞Ë®òÈå≤ÔºàÊú¨Áï™Áí∞Â¢É„Åß„ÅÆÈöúÂÆ≥Ë™øÊüªÁî®Ôºâ %>
                            <% Rails.logger.error "ÊâøË™çÂæÖ„Å°‰ª∂Êï∞ÂèñÂæó„Ç®„É©„Éº: #{e.message}" if Rails.env.production? %>
                            <%# ÈñãÁô∫Áí∞Â¢É„Åß„ÅØË≠¶ÂëäË°®Á§∫„ÄÅÊú¨Áï™Áí∞Â¢É„Åß„ÅØÈùô„Åã„Å´Â§±Êïó %>
                            <% unless Rails.env.production? %>
                              <span class="badge bg-danger">!</span>
                            <% end %>
                          <% end %>
                        <% end %>
                      </li>
                    <% end %>
                    <% if current_admin.headquarters_admin? %>
                      <li>
                        <%= link_to analytics_admin_inter_store_transfers_path, class: "dropdown-item" do %>
                          <i class="bi bi-graph-up me-2"></i>ÂàÜÊûê„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </li>
              <% end %>

              <!-- Âú®Â∫´ÁÆ°ÁêÜ -->
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle <%= 'active' if request.path.include?('/admin/inventories') %>" 
                   href="javascript:void(0)" id="inventoryDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"
                   title="Âú®Â∫´ÁÆ°ÁêÜ">
                  <i class="bi bi-boxes me-1"></i>
                  <span class="d-none d-lg-inline">Âú®Â∫´ÁÆ°ÁêÜ</span>
                  <span class="d-lg-none">Âú®Â∫´</span>
                </a>
                <ul class="dropdown-menu">
                  <li>
                    <%= link_to admin_inventories_path, class: "dropdown-item" do %>
                      <i class="bi bi-list me-2"></i>ÂïÜÂìÅ‰∏ÄË¶ß
                    <% end %>
                  </li>
                  <li>
                    <%= link_to new_admin_inventory_path, class: "dropdown-item" do %>
                      <i class="bi bi-plus-circle me-2"></i>Êñ∞Ë¶èÁôªÈå≤
                    <% end %>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <%= link_to admin_inventories_path(filter: "low_stock"), class: "dropdown-item" do %>
                      <i class="bi bi-exclamation-triangle me-2"></i>‰ΩéÂú®Â∫´„Ç¢„É©„Éº„Éà
                    <% end %>
                  </li>
                  <li>
                    <%= link_to import_form_admin_inventories_path, class: "dropdown-item" do %>
                      <i class="bi bi-upload me-2"></i>CSV„Ç§„É≥„Éù„Éº„Éà
                    <% end %>
                  </li>
                </ul>
              </li>

              <!-- Â±•Ê≠¥„ÉªÁõ£Ë¶ñ -->
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="javascript:void(0)" id="monitorDropdown" role="button" 
                   data-bs-toggle="dropdown" aria-expanded="false" title="Áõ£Ë¶ñ„ÉªÂ±•Ê≠¥">
                  <i class="bi bi-activity me-1"></i>
                  <span class="d-none d-lg-inline">Áõ£Ë¶ñ</span>
                  <span class="d-lg-none">Áõ£Ë¶ñ</span>
                </a>
                <ul class="dropdown-menu">
                  <li>
                    <%# ‚úÖ ÂÆå‰∫Ü: Phase 3 - inventory_logsÊ©üËÉΩ„ÅÆÁÆ°ÁêÜÁîªÈù¢Áµ±ÂêàÔºà2025Âπ¥6ÊúàÔºâ %>
                    <%# CLAUDE.mdÊ∫ñÊã†: ÁÆ°ÁêÜÊ©üËÉΩ„ÅÆ‰∏ÄÂÖÉÂåñÂÆå‰∫Ü %>
                    <%= link_to admin_inventory_logs_path, class: "dropdown-item" do %>
                      <i class="bi bi-journal-text me-2"></i>Âú®Â∫´Â±•Ê≠¥
                    <% end %>
                  </li>
                  <li>
                    <%= link_to admin_audit_logs_path, class: "dropdown-item" do %>
                      <i class="bi bi-shield-check me-2"></i>Áõ£Êüª„É≠„Ç∞
                    <% end %>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <%= link_to security_events_admin_audit_logs_path, class: "dropdown-item" do %>
                      <i class="bi bi-shield-exclamation me-2"></i>„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç§„Éô„É≥„Éà
                    <% end %>
                  </li>
                  <li>
                    <%= link_to user_activity_admin_audit_logs_path, class: "dropdown-item" do %>
                      <i class="bi bi-person-lines-fill me-2"></i>„É¶„Éº„Ç∂„ÉºÊ¥ªÂãïÂ±•Ê≠¥
                    <% end %>
                  </li>
                  <li>
                    <%= link_to compliance_report_admin_audit_logs_path, class: "dropdown-item" do %>
                      <i class="bi bi-file-earmark-check me-2"></i>„Ç≥„É≥„Éó„É©„Ç§„Ç¢„É≥„Çπ„É¨„Éù„Éº„Éà
                    <% end %>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <%# TODO: üü¢ Phase 4ÔºàÊé®Â•®Ôºâ- Sidekiq Web„Éû„Ç¶„É≥„Éà„Ç®„É≥„Ç∏„É≥„ÅÆ„Éë„ÇπÁÆ°ÁêÜ %>
                    <%# ÂÑ™ÂÖàÂ∫¶: ‰ΩéÔºàÊ©üËÉΩÁöÑ„Å´„ÅØÂïèÈ°å„Å™„ÅóÔºâ %>
                    <%# ÂÆüË£ÖÂÜÖÂÆπ: %>
                    <%#   - Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅßSidekiq Web UI„ÅÆ„Éë„Çπ„ÇíÁÆ°ÁêÜ %>
                    <%#   - helper method„Åß„ÅÆ‰∏ÄÂÖÉÁÆ°ÁêÜ %>
                    <%# ÁêÜÁî±: Sidekiq::Web„ÅØÂ§ñÈÉ®„Ç®„É≥„Ç∏„É≥„ÅÆ„Åü„ÇÅ„ÄÅRails„Éë„Çπ„Éò„É´„Éë„Éº„ÅåËá™ÂãïÁîüÊàê„Åï„Çå„Å™„ÅÑ %>
                    <%# ÁèæÁä∂: „Éè„Éº„Éâ„Ç≥„Éº„Éâ„Éë„Çπ„ÅØÊ≠£Â∏∏Âãï‰ΩúÔºàroutes.rb„Åß„Éû„Ç¶„É≥„ÉàÁ¢∫Ë™çÊ∏à„ÅøÔºâ %>
                    <%= link_to "/admin/sidekiq", class: "dropdown-item", target: "_blank", rel: "noopener" do %>
                      <i class="bi bi-gear me-2"></i>„Ç∏„Éß„ÉñÁõ£Ë¶ñ
                    <% end %>
                  </li>
                </ul>
              </li>
            </ul>
            
            <!-- Âè≥ÂÅ¥„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <ul class="navbar-nav">
              <!-- ÈÄöÁü•ÔºàÊú™ÂÆüË£ÖÔºâ -->
              <li class="nav-item">
                <a class="nav-link position-relative" href="javascript:void(0)" title="ÈÄöÁü•ÔºàÂÆüË£Ö‰∫àÂÆöÔºâ">
                  <i class="bi bi-bell"></i>
                  <!-- TODO: Phase 3 - ÈÄöÁü•Ê©üËÉΩÂÆüË£ÖÊôÇ„Å´Ë°®Á§∫ -->
                  <!-- <span class="badge bg-danger position-absolute top-0 start-100 translate-middle">3</span> -->
                </a>
              </li>

              <!-- „É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº -->
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center" href="javascript:void(0)" id="userDropdown" 
                   role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-person-circle me-2"></i>
                  <div class="d-none d-md-block">
                    <div class="small"><%= current_admin.display_name %></div>
                    <div class="text-muted" style="font-size: 0.75rem;"><%= current_admin.role_text %></div>
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li class="dropdown-header">
                    <%= current_admin.email %>
                    <br><small class="text-muted"><%= current_admin.role_text %></small>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <!-- TODO: Phase 4 - „Éó„É≠„Éï„Ç£„Éº„É´Ê©üËÉΩ -->
                  <!-- <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>„Éó„É≠„Éï„Ç£„Éº„É´</a></li> -->
                  <!-- <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Ë®≠ÂÆö</a></li> -->
                  <!-- <li><hr class="dropdown-divider"></li> -->
                  <li>
                    <%= button_to destroy_admin_session_path, method: :delete, 
                        class: "dropdown-item text-danger", title: "„É≠„Ç∞„Ç¢„Ç¶„Éà",
                        form: { data: { turbo: false } } do %>
                      <i class="bi bi-box-arrow-right me-2"></i>„É≠„Ç∞„Ç¢„Ç¶„Éà
                    <% end %>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    <% end %>

    <!-- Main Content -->
    <main class="<%= admin_signed_in? ? 'container-fluid py-4' : 'container py-5' %>">
      <!-- Flash Messages -->
      <% flash.each do |key, value| %>
        <div class="alert alert-<%= key == 'notice' ? 'success' : 'danger' %> alert-dismissible fade show" role="alert">
          <%= value %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% end %>

      <%= yield %>
    </main>

    <!-- Footer -->
    <% if admin_signed_in? %>
      <footer class="bg-admin-primary text-white text-center py-3 mt-auto">
        <div class="container-fluid">
          <p class="mb-0">&copy; <%= Date.today.year %> StockRx - ÁÆ°ÁêÜËÄÖ„Éë„Éç„É´ V1.0</p>
        </div>
      </footer>
    <% end %>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ÁÆ°ÁêÜËÄÖÂú®Â∫´‰∏ÄË¶ßÊ©üËÉΩ -->
    <% if request.path.include?('/admin/inventories') %>
      <%= javascript_include_tag 'admin_inventories', defer: true %>
    <% end %>
  </body>
</html> 