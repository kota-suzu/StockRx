<%# CLAUDE.mdæº–æ‹ : CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆç”»é¢å®Ÿè£… %>
<%# ãƒ¡ã‚¿èªçŸ¥: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®åˆ©ä¾¿æ€§ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®ãƒãƒ©ãƒ³ã‚¹ %>
<% content_for :page_title, "CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ" %>

<div class="container-fluid py-4">
  <%# ãƒ‘ãƒ³ããšãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ %>
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰", admin_root_path %></li>
      <li class="breadcrumb-item"><%= link_to "åœ¨åº«ç®¡ç†", admin_inventories_path %></li>
      <li class="breadcrumb-item active" aria-current="page">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</li>
    </ol>
  </nav>

  <div class="row justify-content-center">
    <div class="col-lg-10">
      <%# ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ %>
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <div class="row align-items-center">
            <div class="col">
              <h4 class="mb-0">
                <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                åœ¨åº«ãƒ‡ãƒ¼ã‚¿CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
              </h4>
              <small class="opacity-75">å¤§é‡ã®åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ã«ä¸€æ‹¬ç™»éŒ²</small>
            </div>
            <div class="col-auto">
              <span class="badge bg-success">
                <i class="bi bi-shield-check me-1"></i>
                ã‚»ã‚­ãƒ¥ã‚¢
              </span>
            </div>
          </div>
        </div>
        
        <div class="card-body">
          <%# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±ãƒ‘ãƒãƒ« - CLAUDE.mdæº–æ‹  %>
          <div class="alert alert-info border-start border-info border-4" role="alert">
            <div class="row">
              <div class="col-md-6">
                <h6 class="alert-heading">
                  <i class="bi bi-info-circle me-2"></i>
                  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶
                </h6>
                <ul class="mb-0 small">
                  <% @import_security_info[:security_measures].each do |measure| %>
                    <li><%= measure %></li>
                  <% end %>
                </ul>
              </div>
              <div class="col-md-6">
                <h6 class="alert-heading">
                  <i class="bi bi-check-circle me-2"></i>
                  å¿…é ˆé …ç›®
                </h6>
                <ul class="mb-0 small">
                  <% @import_security_info[:required_headers].each do |header| %>
                    <li><strong><%= header %></strong> - <%= header_description(header) %></li>
                  <% end %>
                </ul>
              </div>
            </div>
          </div>

          <%# CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ  - CLAUDE.mdæº–æ‹ å®Ÿè£… %>
          <%= form_with url: import_admin_inventories_path, 
                        multipart: true,
                        local: true,
                        html: { 
                          id: "csv-import-form",
                          class: "needs-validation",
                          novalidate: true,
                          data: { 
                            turbo: false
                          }
                        } do |form| %>
            
            <%# ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ %>
            <div class="mb-4">
              <h5 class="mb-3">
                <i class="bi bi-upload me-2"></i>
                CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
              </h5>
              
              <div class="card">
                <div class="card-body text-center">
                  <div class="upload-area border-2 border-dashed border-primary rounded p-4 position-relative"
                       style="min-height: 200px;">
                    
                    <%# ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ %>
                    <div class="d-flex flex-column justify-content-center align-items-center h-100">
                      <i class="bi bi-cloud-upload text-primary mb-3" style="font-size: 3rem;"></i>
                      <h6 class="text-primary mb-2">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</h6>
                      <p class="text-muted small mb-3">
                        æœ€å¤§ã‚µã‚¤ã‚º: <%= @import_security_info[:max_file_size] %><br>
                        å¯¾å¿œå½¢å¼: <%= @import_security_info[:allowed_formats].join(", ") %>
                      </p>
                      
                      <%# ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ %>
                      <%= form.file_field :csv_file, 
                                         class: "form-control form-control-lg",
                                         accept: ".csv",
                                         required: true,
                                         aria: { 
                                           describedby: "file-help" 
                                         } %>
                      
                      <div class="invalid-feedback">
                        CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
                      </div>
                    </div>
                  </div>
                  
                  <div id="file-help" class="form-text mt-2">
                    <i class="bi bi-info-circle me-1"></i>
                    UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
                  </div>
                </div>
              </div>
            </div>

            <%# ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ %>
            <div class="mb-4">
              <h5 class="mb-3">
                <i class="bi bi-gear me-2"></i>
                ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®š
              </h5>
              
              <div class="card">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-check mb-3">
                        <%= form.check_box :update_existing, 
                                          class: "form-check-input",
                                          id: "update_existing" %>
                        <%= form.label :update_existing, 
                                      class: "form-check-label" do %>
                          <strong>æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</strong>
                          <br><small class="text-muted">åŒã˜å•†å“åã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ä¸Šæ›¸ãæ›´æ–°ã—ã¾ã™</small>
                        <% end %>
                      </div>
                      
                      <div class="form-check mb-3">
                        <%= form.check_box :skip_invalid, 
                                          class: "form-check-input",
                                          id: "skip_invalid" %>
                        <%= form.label :skip_invalid, 
                                      class: "form-check-label" do %>
                          <strong>ã‚¨ãƒ©ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—</strong>
                          <br><small class="text-muted">ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®è¡Œã‚’é™¤å¤–ã—ã¦å‡¦ç†ã‚’ç¶šè¡Œ</small>
                        <% end %>
                      </div>
                    </div>
                    
                    <div class="col-md-6">
                      <div class="mb-3">
                        <%= form.label :unique_key, "è­˜åˆ¥ã‚­ãƒ¼", class: "form-label" %>
                        <%= form.select :unique_key, 
                                       options_for_select([
                                         ["å•†å“å", "name"],
                                         ["ãƒãƒ¼ã‚³ãƒ¼ãƒ‰", "barcode"],
                                         ["å•†å“ã‚³ãƒ¼ãƒ‰", "code"]
                                       ], "name"),
                                       {},
                                       { 
                                         class: "form-select",
                                         aria: { describedby: "unique-key-help" }
                                       } %>
                        <div id="unique-key-help" class="form-text">
                          æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®ç…§åˆã«ä½¿ç”¨ã™ã‚‹ã‚­ãƒ¼ã‚’é¸æŠ
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <%# CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¡ˆå†…ã‚»ã‚¯ã‚·ãƒ§ãƒ³ %>
            <div class="mb-4">
              <h5 class="mb-3">
                <i class="bi bi-table me-2"></i>
                CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
              </h5>
              
              <div class="card">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <h6 class="text-primary mb-3">å¿…é ˆã‚«ãƒ©ãƒ </h6>
                      <% @import_security_info[:required_headers].each do |header| %>
                        <div class="d-flex justify-content-between mb-2">
                          <code class="text-primary"><%= header %></code>
                          <small class="text-muted"><%= header_description(header) %></small>
                        </div>
                      <% end %>
                    </div>
                    
                    <div class="col-md-6">
                      <h6 class="text-success mb-3">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿</h6>
                      <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                          <thead class="table-light">
                            <tr>
                              <% @csv_template_headers.each do |header| %>
                                <th class="text-center small"><%= header %></th>
                              <% end %>
                            </tr>
                          </thead>
                          <tbody>
                            <% @csv_sample_data.each do |row| %>
                              <tr>
                                <% row.each do |cell| %>
                                  <td class="text-center small"><%= cell %></td>
                                <% end %>
                              </tr>
                            <% end %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                  
                  <%# ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ %>
                  <div class="row mt-3">
                    <div class="col-12">
                      <div class="d-flex gap-2 flex-wrap">
                        <button type="button" 
                                class="btn btn-sm btn-outline-primary"
                                onclick="downloadCsvTemplate()">
                          <i class="bi bi-download me-1"></i>
                          ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>
                        
                        <button type="button" 
                                class="btn btn-sm btn-outline-info"
                                data-bs-toggle="modal" 
                                data-bs-target="#formatGuideModal">
                          <i class="bi bi-question-circle me-1"></i>
                          ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¬ã‚¤ãƒ‰
                        </button>
                        
                        <% if @current_import_jobs.any? %>
                          <span class="badge bg-warning fs-6">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ä¸­
                          </span>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <%# ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ %>
            <div class="d-flex gap-2 justify-content-between align-items-center">
              <%= link_to admin_inventories_path, 
                         class: "btn btn-outline-secondary" do %>
                <i class="bi bi-arrow-left me-1"></i>
                æˆ»ã‚‹
              <% end %>
              
              <div class="d-flex gap-2">
                <button type="button" 
                        class="btn btn-outline-primary"
                        onclick="validateBeforeSubmit()"
                        id="preview-button">
                  <i class="bi bi-eye me-1"></i>
                  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </button>
                
                <%= form.submit "ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹", 
                               class: "btn btn-primary btn-lg",
                               id: "submit-button",
                               data: { 
                                 confirm: "CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚"
                               } %>
              </div>
            </div>
          <% end %>

          <%# é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆéè¡¨ç¤ºçŠ¶æ…‹ï¼‰ %>
          <div id="import-progress" class="mt-4 d-none">
            <div class="card border-info">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                  <i class="bi bi-gear-wide-connected me-2"></i>
                  ã‚¤ãƒ³ãƒãƒ¼ãƒˆé€²æ—
                </h6>
              </div>
              <div class="card-body">
                <div class="progress mb-3" style="height: 20px;">
                  <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                       role="progressbar" 
                       style="width: 0%"
                       aria-valuenow="0" 
                       aria-valuemin="0" 
                       aria-valuemax="100"
                       id="progress-bar">
                    <span id="progress-text">0%</span>
                  </div>
                </div>
                
                <div class="row text-center">
                  <div class="col-md-3">
                    <div class="text-success">
                      <i class="bi bi-check-circle fs-4"></i>
                      <div class="fw-bold" id="success-count">0</div>
                      <small class="text-muted">æˆåŠŸ</small>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-danger">
                      <i class="bi bi-x-circle fs-4"></i>
                      <div class="fw-bold" id="error-count">0</div>
                      <small class="text-muted">ã‚¨ãƒ©ãƒ¼</small>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-info">
                      <i class="bi bi-clock fs-4"></i>
                      <div class="fw-bold" id="processed-count">0</div>
                      <small class="text-muted">å‡¦ç†æ¸ˆã¿</small>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-muted">
                      <i class="bi bi-layers fs-4"></i>
                      <div class="fw-bold" id="total-count">0</div>
                      <small class="text-muted">åˆè¨ˆ</small>
                    </div>
                  </div>
                </div>
                
                <div class="mt-3">
                  <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> 
                  <span id="import-status" class="badge bg-info">æº–å‚™ä¸­</span>
                </div>
                
                <div id="import-messages" class="mt-3">
                  <!-- å‡¦ç†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <%# ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ï¼ˆéè¡¨ç¤ºçŠ¶æ…‹ï¼‰ %>
      <div class="card shadow-sm mt-4 d-none" id="preview-card">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-eye me-2"></i>
            ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
          </h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead class="table-dark">
                <tr id="preview-headers">
                  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </tr>
              </thead>
              <tbody id="preview-tbody">
                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
              </tbody>
            </table>
          </div>
          <div class="mt-3 text-muted">
            <small>æœ€åˆã®5è¡Œã®ã¿è¡¨ç¤ºã€‚å®Ÿéš›ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ã¯å…¨ã¦ã®è¡ŒãŒå‡¦ç†ã•ã‚Œã¾ã™ã€‚</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« %>
<div class="modal fade" id="formatGuideModal" tabindex="-1" aria-labelledby="formatGuideModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="formatGuideModalLabel">
          <i class="bi bi-book me-2"></i>
          CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¬ã‚¤ãƒ‰
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-primary">åŸºæœ¬è¦ä»¶</h6>
            <ul class="list-unstyled">
              <li><i class="bi bi-check-circle text-success me-2"></i>UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</li>
              <li><i class="bi bi-check-circle text-success me-2"></i>ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆCSVå½¢å¼ï¼‰</li>
              <li><i class="bi bi-check-circle text-success me-2"></i>1è¡Œç›®ã«ãƒ˜ãƒƒãƒ€ãƒ¼å¿…é ˆ</li>
              <li><i class="bi bi-check-circle text-success me-2"></i>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º10MBä»¥ä¸‹</li>
            </ul>
            
            <h6 class="text-warning mt-4">æ³¨æ„äº‹é …</h6>
            <ul class="list-unstyled">
              <li><i class="bi bi-exclamation-triangle text-warning me-2"></i>å•†å“åã«ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€å ´åˆã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€</li>
              <li><i class="bi bi-exclamation-triangle text-warning me-2"></i>ä¾¡æ ¼ã¯æ•°å€¤ã®ã¿ï¼ˆé€šè²¨è¨˜å·ä¸å¯ï¼‰</li>
              <li><i class="bi bi-exclamation-triangle text-warning me-2"></i>åœ¨åº«æ•°é‡ã¯æ­£ã®æ•´æ•°ã®ã¿</li>
            </ul>
          </div>
          
          <div class="col-md-6">
            <h6 class="text-info">ä¾‹ï¼šæ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</h6>
            <pre class="bg-light p-3 rounded"><code>name,quantity,price,status
"ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³",15,128000,active
"ãƒã‚¦ã‚¹",50,7800,active
"ãƒ¢ãƒ‹ã‚¿ãƒ¼",25,45000,active</code></pre>
            
            <h6 class="text-danger mt-3">ä¾‹ï¼šé–“é•ã£ãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</h6>
            <pre class="bg-light p-3 rounded"><code>å•†å“å;æ•°é‡;ä¾¡æ ¼  â†ã‚»ãƒŸã‚³ãƒ­ãƒ³åŒºåˆ‡ã‚Šã¯ä¸å¯
ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³,15å€‹,Â¥128,000  â†å˜ä½ã‚„é€šè²¨è¨˜å·ã¯ä¸å¯
ãƒã‚¦ã‚¹,-5,7800  â†è² ã®æ•°ã¯ä¸å¯</code></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<%# JavaScriptå®Ÿè£… - CLAUDE.mdæº–æ‹  %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ============================================
  // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®JavaScriptå®Ÿè£…
  // CLAUDE.mdæº–æ‹ : ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã€ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ
  // ============================================
  
  const form = document.getElementById('csv-import-form');
  const fileInput = document.querySelector('input[type="file"]');
  const previewButton = document.getElementById('preview-button');
  const submitButton = document.getElementById('submit-button');
  const previewCard = document.getElementById('preview-card');
  const progressArea = document.getElementById('import-progress');
  
  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
  fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      validateFile(file);
      previewButton.disabled = false;
    } else {
      previewButton.disabled = true;
      hidePreview();
    }
  });
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  function validateFile(file) {
    const maxSize = 10 * 1024 * 1024; // 10MB
    const allowedTypes = ['text/csv', 'application/csv'];
    
    // ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
    if (file.size > maxSize) {
      showAlert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚10MBä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'danger');
      fileInput.value = '';
      return false;
    }
    
    // æ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯
    if (!file.name.toLowerCase().endsWith('.csv')) {
      showAlert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'danger');
      fileInput.value = '';
      return false;
    }
    
    return true;
  }
  
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
  window.validateBeforeSubmit = function() {
    const file = fileInput.files[0];
    if (!file) {
      showAlert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const csv = e.target.result;
        const lines = csv.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          showAlert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'warning');
          return;
        }
        
        displayPreview(lines.slice(0, 6)); // ãƒ˜ãƒƒãƒ€ãƒ¼ + 5è¡Œ
        showAlert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã€å•é¡Œãªã‘ã‚Œã°ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'info');
        
      } catch (error) {
        showAlert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'danger');
      }
    };
    
    reader.readAsText(file, 'UTF-8');
  };
  
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
  function displayPreview(lines) {
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const data = lines.slice(1);
    
    const headersHtml = headers.map(h => `<th class="text-center">${escapeHtml(h)}</th>`).join('');
    document.getElementById('preview-headers').innerHTML = headersHtml;
    
    const bodyHtml = data.map(line => {
      const cells = line.split(',').map(c => c.trim().replace(/"/g, ''));
      const cellsHtml = cells.map(c => `<td class="text-center">${escapeHtml(c)}</td>`).join('');
      return `<tr>${cellsHtml}</tr>`;
    }).join('');
    
    document.getElementById('preview-tbody').innerHTML = bodyHtml;
    previewCard.classList.remove('d-none');
  }
  
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º
  function hidePreview() {
    previewCard.classList.add('d-none');
  }
  
  // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
  function showAlert(message, type = 'info') {
    // æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
    const existingAlert = document.querySelector('.alert-dismissible');
    if (existingAlert && existingAlert.closest('.container-fluid') === document.querySelector('.container-fluid')) {
      existingAlert.remove();
    }
    
    const alertHtml = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        ${escapeHtml(message)}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã®å‰ã«æŒ¿å…¥
    form.insertAdjacentHTML('beforebegin', alertHtml);
    
    // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      const alert = document.querySelector('.alert-dismissible');
      if (alert) {
        alert.remove();
      }
    }, 5000);
  }
  
  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  window.downloadCsvTemplate = function() {
    const csvContent = `name,quantity,price,status
"ã‚µãƒ³ãƒ—ãƒ«å•†å“A",100,1500,active
"ã‚µãƒ³ãƒ—ãƒ«å•†å“B",50,2000,active
"ã‚µãƒ³ãƒ—ãƒ«å•†å“C",200,800,active`;
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', 'inventory_template.csv');
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚', 'success');
  };
  
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
  form.addEventListener('submit', function(e) {
    // åŸºæœ¬ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!fileInput.files[0]) {
      e.preventDefault();
      showAlert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
      return false;
    }
    
    // é€ä¿¡ä¸­ã®çŠ¶æ…‹ã«å¤‰æ›´
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="bi bi-gear-wide-connected me-2"></i>å‡¦ç†ä¸­...';
    
    // é€²æ—ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
    progressArea.classList.remove('d-none');
    
    // ActionCableçµ±åˆã«ã‚ˆã‚‹é€²æ—è¡¨ç¤º
    setupActionCableConnection();
  });
  
  // ============================================
  // ActionCableçµ±åˆæ©Ÿèƒ½
  // ============================================
  
  function setupActionCableConnection() {
    // ActionCableãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (typeof App === 'undefined' || !App.cable) {
      console.warn('ActionCable not available. Real-time updates disabled.');
      return;
    }

    // ImportProgressChannelã«æ¥ç¶š
    const subscription = App.cable.subscriptions.create("ImportProgressChannel", {
      connected() {
        console.log('ğŸ“¡ Import progress channel connected');
        showAlert('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¡¨ç¤ºã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚', 'info');
      },

      disconnected() {
        console.log('ğŸ“¡ Import progress channel disconnected');
        showAlert('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¡¨ç¤ºãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚', 'warning');
      },

      received(data) {
        console.log('ğŸ“¨ Progress update received:', data);
        handleProgressUpdate(data);
      },

      error(error) {
        console.error('âŒ Import progress channel error:', error);
        showAlert('é€²æ—è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'danger');
      }
    });

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    window.addEventListener('beforeunload', () => {
      if (subscription) {
        subscription.unsubscribe();
      }
    });
  }

  function handleProgressUpdate(data) {
    const progressArea = document.getElementById('import-progress');
    const messagesArea = document.getElementById('import-messages');
    
    if (!progressArea || !messagesArea) {
      console.warn('Progress display elements not found');
      return;
    }

    switch (data.status) {
      case 'progress':
        updateProgressBar(data);
        updateProgressMessage(data);
        break;
      case 'completed':
        handleImportCompletion(data);
        break;
      case 'error':
        handleImportError(data);
        break;
      default:
        console.log('Unknown progress status:', data.status);
    }
  }

  function updateProgressBar(data) {
    let progressBar = document.querySelector('#import-progress .progress-bar');
    
    if (!progressBar) {
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
      const progressHtml = `
        <div class="progress mb-3" style="height: 25px;">
          <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
               role="progressbar" style="width: 0%">
            <span class="progress-text">0%</span>
          </div>
        </div>
      `;
      document.getElementById('import-progress').innerHTML = progressHtml;
      progressBar = document.querySelector('.progress-bar');
    }

    const percentage = Math.min(Math.max(data.progress || 0, 0), 100);
    progressBar.style.width = `${percentage}%`;
    progressBar.setAttribute('aria-valuenow', percentage);
    
    const progressText = progressBar.querySelector('.progress-text');
    if (progressText) {
      progressText.textContent = `${percentage.toFixed(1)}%`;
    }

    // å‡¦ç†æ¸ˆã¿/ç·æ•°ã®è¡¨ç¤º
    if (data.processed && data.total) {
      const statusText = ` (${data.processed}/${data.total})`;
      if (progressText) {
        progressText.textContent += statusText;
      }
    }
  }

  function updateProgressMessage(data) {
    const message = data.message || data.current_item || 'CSVãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...';
    const timestamp = new Date().toLocaleTimeString();
    
    const messageHtml = `
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        <strong>${timestamp}:</strong> ${escapeHtml(message)}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    
    document.getElementById('import-messages').innerHTML = messageHtml;
  }

  function handleImportCompletion(data) {
    const result = data.result || {};
    const successMessage = `
      ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼<br>
      <strong>å‡¦ç†ä»¶æ•°:</strong> ${result.processed || 0}ä»¶<br>
      <strong>æˆåŠŸ:</strong> ${result.successful || 0}ä»¶<br>
      <strong>å¤±æ•—:</strong> ${result.failed || 0}ä»¶
    `;

    showAlert(successMessage, 'success');
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ã«è¨­å®š
    updateProgressBar({ progress: 100 });
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’å†æœ‰åŠ¹åŒ–
    const submitButton = document.getElementById('submit-button');
    if (submitButton) {
      submitButton.disabled = false;
      submitButton.innerHTML = '<i class="bi bi-upload me-2"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹';
    }

    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯è©³ç´°è¡¨ç¤º
    if (result.errors && result.errors.length > 0) {
      const errorList = result.errors.slice(0, 5).map(err => `â€¢ ${err}`).join('<br>');
      const errorMessage = `<strong>ã‚¨ãƒ©ãƒ¼è©³ç´°:</strong><br>${errorList}`;
      if (result.errors.length > 5) {
        errorMessage += `<br><em>...ä»– ${result.errors.length - 5} ä»¶ã®ã‚¨ãƒ©ãƒ¼</em>`;
      }
      
      setTimeout(() => {
        showAlert(errorMessage, 'warning');
      }, 2000);
    }
  }

  function handleImportError(data) {
    const errorMessage = data.message || 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
    const details = data.details || {};
    
    let fullMessage = `<strong>ã‚¨ãƒ©ãƒ¼:</strong> ${escapeHtml(errorMessage)}`;
    
    if (details.line_number) {
      fullMessage += `<br><strong>è¡Œç•ªå·:</strong> ${details.line_number}`;
    }
    
    if (details.error_type) {
      fullMessage += `<br><strong>ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—:</strong> ${details.error_type}`;
    }

    showAlert(fullMessage, 'danger');
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’å†æœ‰åŠ¹åŒ–
    const submitButton = document.getElementById('submit-button');
    if (submitButton) {
      submitButton.disabled = false;
      submitButton.innerHTML = '<i class="bi bi-upload me-2"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹';
    }
  }

  // TODO: ğŸŸ¡ Phase 6ï¼ˆæ¨å¥¨ï¼‰- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½å®Ÿè£…
  // å„ªå…ˆåº¦: ä¸­ï¼ˆUXæ”¹å–„ï¼‰
  // å®Ÿè£…å†…å®¹: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã€è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  // åŠ¹æœ: ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šã€ãƒ¢ãƒ€ãƒ³ãªUIä½“é¨“
});
</script>