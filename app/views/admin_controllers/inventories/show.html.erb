<%# 在庫詳細 - 統一UI版 %>
<div class="container-fluid py-4">
  <%# 統一ページヘッダー %>
  <%= render 'admin_controllers/shared/page_header',
             title: @inventory.name,
             subtitle: "最終更新: #{l(@inventory.updated_at, format: :short) if @inventory.updated_at.present?}",
             icon: 'bi-box',
             icon_color: 'primary',
             back_path: admin_inventories_path,
             back_text: '一覧に戻る',
             breadcrumbs: [
               { text: 'ダッシュボード', path: admin_root_path, icon: 'bi-house' },
               { text: '在庫管理', path: admin_inventories_path, icon: 'bi-box' },
               { text: @inventory.name, active: true }
             ],
             actions: [
               {
                 text: '編集',
                 path: edit_admin_inventory_path(@inventory),
                 icon: 'bi-pencil',
                 class: 'btn-warning'
               },
               {
                 text: '削除',
                 path: admin_inventory_path(@inventory),
                 method: :delete,
                 icon: 'bi-trash',
                 class: 'btn-danger',
                 confirm: 'この在庫を削除してもよろしいですか？'
               }
             ] %>

  <%# ステータスバッジ表示 %>
  <div class="mb-4 d-flex align-items-center gap-3">
    <%= render 'admin_controllers/shared/status_badge',
               status: @inventory.status,
               type: 'status' %>
    <%= render 'admin_controllers/shared/status_badge',
               status: @inventory.alert_level,
               type: 'level' %>
  </div>

  <%# メイン情報カード群 %>
  <div class="row g-4 mb-4">
    <%# 基本情報 %>
    <div class="col-lg-4">
      <div class="card admin-card h-100">
        <div class="card-header bg-primary text-white">
          <h2 class="card-title mb-0">
            <i class="bi bi-info-circle me-2"></i>基本情報
          </h2>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12">
              <div class="bg-light p-3 rounded">
                <h6 class="text-muted mb-1">商品名</h6>
                <h4 class="mb-0"><%= @inventory.name %></h4>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center">
                <div class="h5 text-success mb-1">
                  <i class="bi bi-currency-yen me-1"></i><%= number_with_delimiter(@inventory.price) %>
                </div>
                <small class="text-muted">価格（円）</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center">
                <div class="h5 mb-1 <%= @inventory.quantity <= 0 ? 'text-danger' : @inventory.quantity < 10 ? 'text-warning' : 'text-success' %>">
                  <i class="bi bi-boxes me-1"></i><%= @inventory.quantity %>
                </div>
                <small class="text-muted">在庫数（個）</small>
              </div>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">ステータス</span>
                <%= @inventory.status_badge %>
              </div>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">在庫状態</span>
                <%= @inventory.alert_badge %>
              </div>
            </div>
            <div class="col-12">
              <small class="text-muted">
                最終更新: <%= l(@inventory.updated_at, format: :long) if @inventory.updated_at.present? %>
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%# バッチ情報サマリー %>
    <div class="col-lg-4">
      <div class="card admin-card h-100">
        <div class="card-header bg-info text-white">
          <h2 class="card-title mb-0">
            <i class="bi bi-layers me-2"></i>ロット情報
          </h2>
        </div>
        <div class="card-body">
          <div class="row g-3 text-center">
            <div class="col-12">
              <div class="bg-light p-3 rounded">
                <div class="h3 text-info mb-1">
                  <i class="bi bi-boxes me-1"></i><%= @inventory.batches_count %>
                </div>
                <h6 class="text-muted mb-0">ロット総数</h6>
              </div>
            </div>
            <div class="col-6">
              <% expired_count = @inventory.batches.select(&:expired?).count %>
              <div class="p-2 <%= expired_count > 0 ? 'bg-danger bg-opacity-10' : 'bg-light' %> rounded">
                <div class="h5 mb-1 <%= expired_count > 0 ? 'text-danger' : 'text-muted' %>">
                  <i class="bi bi-exclamation-triangle me-1"></i><%= expired_count %>
                </div>
                <small class="text-muted">期限切れ</small>
                <% if expired_count > 0 %>
                  <div class="mt-1">
                    <span class="badge bg-danger">要確認</span>
                  </div>
                <% end %>
              </div>
            </div>
            <div class="col-6">
              <% expiring_soon_count = @inventory.batches.select(&:expiring_soon?).count %>
              <div class="p-2 <%= expiring_soon_count > 0 ? 'bg-warning bg-opacity-10' : 'bg-light' %> rounded">
                <div class="h5 mb-1 <%= expiring_soon_count > 0 ? 'text-warning' : 'text-muted' %>">
                  <i class="bi bi-clock me-1"></i><%= expiring_soon_count %>
                </div>
                <small class="text-muted">期限間近</small>
                <% if expiring_soon_count > 0 %>
                  <div class="mt-1">
                    <span class="badge bg-warning">確認推奨</span>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
          <% if @inventory.batches_count > 0 %>
            <div class="mt-3">
              <div class="progress" style="height: 8px;">
                <% 
                  normal_count = @inventory.batches_count - expired_count - expiring_soon_count
                  normal_percentage = (normal_count.to_f / @inventory.batches_count * 100).round(1)
                  expiring_percentage = (expiring_soon_count.to_f / @inventory.batches_count * 100).round(1)
                  expired_percentage = (expired_count.to_f / @inventory.batches_count * 100).round(1)
                %>
                <div class="progress-bar bg-success" style="width: <%= normal_percentage %>%" title="正常: <%= normal_count %>件"></div>
                <div class="progress-bar bg-warning" style="width: <%= expiring_percentage %>%" title="期限間近: <%= expiring_soon_count %>件"></div>
                <div class="progress-bar bg-danger" style="width: <%= expired_percentage %>%" title="期限切れ: <%= expired_count %>件"></div>
              </div>
              <div class="mt-1 small text-muted text-center">
                正常 <%= normal_count %>件 | 期限間近 <%= expiring_soon_count %>件 | 期限切れ <%= expired_count %>件
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <%# 操作履歴・統計情報 %>
    <div class="col-lg-4">
      <div class="card admin-card h-100">
        <div class="card-header bg-secondary text-white">
          <h2 class="card-title mb-0">
            <i class="bi bi-graph-up me-2"></i>統計・履歴
          </h2>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12">
              <div class="alert alert-info">
                <h6 class="alert-heading">
                  <i class="fas fa-info-circle me-2"></i>統計情報
                </h6>
                <ul class="mb-0 small">
                  <li>商品登録日: <%= l(@inventory.created_at, format: :short) %></li>
                  <li>最後の更新: <%= l(@inventory.updated_at, format: :short) %></li>
                  <li>在庫ID: #<%= @inventory.id %></li>
                </ul>
              </div>
            </div>
            <div class="col-12">
              <div class="alert alert-warning">
                <h6 class="alert-heading">
                  <i class="fas fa-tools me-2"></i>将来実装予定
                </h6>
                <ul class="mb-0 small">
                  <li>在庫の操作履歴表示</li>
                  <li>入出庫履歴の詳細</li>
                  <li>売上・回転率統計</li>
                  <li>アラート・通知設定</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# バッチ一覧テーブル %>
  <div class="card admin-card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2 class="card-title mb-0">
        <i class="bi bi-layers me-2"></i>ロット一覧
      </h2>
      <div>
        <%# TODO: 🟡 Phase 3（重要）- バッチ追加・編集機能の実装 %>
        <%# 優先度: 中（在庫管理機能の完成） %>
        <%# 実装内容: CRUD機能、バリデーション、権限制御 %>
        <%# 期待効果: 在庫管理の完全自動化、データ精度向上 %>
        <button class="btn btn-success" disabled>
          <i class="bi bi-plus me-2"></i>ロット追加
        </button>
        <small class="text-muted ms-2">（実装予定）</small>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive admin-table">
        <table class="table table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th scope="col">
                <i class="bi bi-upc me-1"></i>ロットコード
              </th>
              <th scope="col">
                <i class="bi bi-boxes me-1"></i>数量
              </th>
              <th scope="col">
                <i class="bi bi-percent me-1"></i>割合
              </th>
              <th scope="col">
                <i class="bi bi-calendar-event me-1"></i>有効期限
              </th>
              <th scope="col">
                <i class="bi bi-traffic-light me-1"></i>状態
              </th>
              <th scope="col" class="text-end">
                <i class="bi bi-gear me-1"></i>アクション
              </th>
            </tr>
          </thead>
          <tbody>
            <% if @inventory.batches.present? %>
              <% @inventory.batches.each do |batch| %>
                <tr class="<%= batch_row_class(batch) %>">
                  <td class="fw-bold">
                    <code class="text-primary"><%= batch.lot_code %></code>
                  </td>
                  <td>
                    <span class="badge bg-secondary">
                      <%= batch.quantity %> 個
                    </span>
                    <% if batch.quantity > 0 %>
                      <div class="progress mt-1" style="height: 5px;">
                        <div class="progress-bar bg-info" 
                             style="width: <%= lot_quantity_percentage(batch, @inventory.quantity) %>%" 
                             title="在庫数に対する割合"></div>
                      </div>
                    <% end %>
                  </td>
                  <td class="text-center">
                    <% if @inventory.quantity > 0 %>
                      <span class="badge bg-light text-dark">
                        <%= lot_quantity_percentage(batch, @inventory.quantity) %>%
                      </span>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                  <td>
                    <% if batch.expires_on.present? %>
                      <i class="bi bi-calendar-event me-1 text-muted"></i>
                      <%= l(batch.expires_on, format: :short) %>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                  <td>
                    <% if batch.expired? %>
                      <%= render 'admin_controllers/shared/status_badge',
                                 status: 'expired',
                                 text: '期限切れ',
                                 type: 'level' %>
                    <% elsif batch.expiring_soon? %>
                      <%= render 'admin_controllers/shared/status_badge',
                                 status: 'expiring_soon',
                                 text: '期限間近',
                                 type: 'level' %>
                    <% else %>
                      <%= render 'admin_controllers/shared/status_badge',
                                 status: 'normal',
                                 text: '正常',
                                 type: 'level' %>
                    <% end %>
                  </td>
                  <td class="text-end">
                    <%= render 'admin_controllers/shared/action_buttons',
                               buttons: [
                                 {
                                   text: '編集',
                                   path: nil,
                                   icon: 'bi-pencil',
                                   class: 'btn-outline-warning',
                                   disabled: true,
                                   tooltip: '実装予定'
                                 },
                                 {
                                   text: '削除',
                                   path: nil,
                                   icon: 'bi-trash',
                                   class: 'btn-outline-danger',
                                   disabled: true,
                                   tooltip: '実装予定'
                                 }
                               ],
                               size: 'sm',
                               layout: 'group' %>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="6" class="text-center py-5">
                  <div class="text-muted">
                    <i class="bi bi-box display-4 mb-3"></i>
                    <h6>ロットデータがありません</h6>
                    <p class="mb-0">「ロット追加」ボタンからロットを登録してください</p>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<%# Enhanced JavaScript for interactive features %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ツールチップの初期化（Bootstrap 5）
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // プログレスバーのホバー効果
  const progressBars = document.querySelectorAll('.progress-bar');
  progressBars.forEach(bar => {
    bar.addEventListener('mouseenter', function() {
      this.style.opacity = '0.8';
    });
    bar.addEventListener('mouseleave', function() {
      this.style.opacity = '1';
    });
  });

  // カードのホバー効果
  const cards = document.querySelectorAll('.card');
  cards.forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-2px)';
      this.style.transition = 'all 0.2s ease-in-out';
    });
    card.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
    });
  });

  // 削除ボタンの確認ダイアログ強化
  const deleteButton = document.querySelector('button[formmethod="delete"]');
  if (deleteButton) {
    deleteButton.addEventListener('click', function(e) {
      e.preventDefault();
      
      const inventoryName = '<%= j(@inventory.name) %>';
      const confirmText = `商品「${inventoryName}」を削除してもよろしいですか？\n\nこの操作は取り消せません。関連するロット情報も全て削除されます。`;
      
      if (confirm(confirmText)) {
        this.closest('form').submit();
      }
    });
  }
});
</script>

<%# TODO: 🟡 Phase 3-4（重要）- 在庫管理機能完全実装 %>
<%# 優先度: 中（機能完成度向上） %>
<%# 実装内容: %>
<%#   - ロットCRUD機能（追加・編集・削除） %>
<%#   - 在庫操作履歴の表示機能 %>
<%#   - 在庫アラート・通知設定 %>
<%#   - 在庫統計・分析機能 %>
<%#   - エクスポート機能（PDF・Excel） %>
<%# 期待効果: 完全な在庫管理システム、業務効率化、データ分析強化 %>
<%# - エクスポート機能（PDF・Excel） %> 