<%# ğŸª åº—èˆ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - Phase 2: Multi-Store Management %>
<div class="container-fluid py-4">
  <%# ãƒ‘ãƒ³ããšãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ %>
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <%= link_to admin_stores_path, class: "text-decoration-none" do %>
          <i class="bi bi-shop me-1" aria-hidden="true"></i>åº—èˆ—ç®¡ç†
        <% end %>
      </li>
      <li class="breadcrumb-item">
        <%= link_to admin_store_path(@store), class: "text-decoration-none" do %>
          <%= @store.name %>
        <% end %>
      </li>
      <li class="breadcrumb-item active" aria-current="page">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</li>
    </ol>
  </nav>

  <%# ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ %>
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-lg-8">
              <div class="d-flex align-items-center mb-2">
                <div class="store-dashboard-icon me-3">
                  <% if @store.pharmacy? %>
                    <i class="bi bi-hospital text-admin-primary"></i>
                  <% elsif @store.warehouse? %>
                    <i class="bi bi-building text-info"></i>
                  <% else %>
                    <i class="bi bi-building-check text-success"></i>
                  <% end %>
                </div>
                <div>
                  <h1 class="h2 mb-1 fw-bold"><%= @store.name %> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                  <p class="text-muted mb-0">
                    ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åº—èˆ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»åœ¨åº«ç›£è¦–
                    <span class="badge bg-success ms-2">
                      <i class="bi bi-circle-fill text-success me-1" style="font-size: 8px;" aria-hidden="true"></i>
                      ã‚ªãƒ³ãƒ©ã‚¤ãƒ³
                    </span>
                  </p>
                </div>
              </div>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
              <div class="d-flex flex-column align-items-lg-end">
                <small class="text-muted mb-1">
                  <i class="bi bi-clock me-1" aria-hidden="true"></i>
                  æœ€çµ‚æ›´æ–°: <%= l(Time.current, format: :short) %>
                </small>
                <div class="efficiency-score">
                  <span class="badge bg-admin-primary fs-6">
                    åŠ¹ç‡ã‚¹ã‚³ã‚¢: <%= @dashboard_stats[:efficiency_score] %>%
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# KPIçµ±è¨ˆã‚«ãƒ¼ãƒ‰ %>
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="icon-lg mb-3 mx-auto bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center">
            <i class="bi bi-boxes" aria-hidden="true"></i>
          </div>
          <h3 class="fw-bold text-primary mb-1"><%= @dashboard_stats[:total_items] %></h3>
          <p class="text-muted small mb-2">ç·åœ¨åº«ã‚¢ã‚¤ãƒ†ãƒ </p>
          <div class="progress" style="height: 4px;">
            <div class="progress-bar bg-primary" 
                 role="progressbar" 
                 style="width: <%= [@dashboard_stats[:total_items] * 2, 100].min %>%"
                 aria-valuenow="<%= @dashboard_stats[:total_items] %>" 
                 aria-valuemin="0" 
                 aria-valuemax="50"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="icon-lg mb-3 mx-auto bg-success-subtle text-success rounded-circle d-flex align-items-center justify-content-center">
            <i class="bi bi-currency-yen" aria-hidden="true"></i>
          </div>
          <h3 class="fw-bold text-success mb-1">Â¥<%= number_with_delimiter(@dashboard_stats[:total_value]) %></h3>
          <p class="text-muted small mb-2">ç·åœ¨åº«ä¾¡å€¤</p>
          <div class="d-flex justify-content-between small text-muted">
            <span>åˆ©ç”¨å¯èƒ½: Â¥<%= number_with_delimiter(@dashboard_stats[:available_value]) %></span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="icon-lg mb-3 mx-auto bg-warning-subtle text-warning rounded-circle d-flex align-items-center justify-content-center">
            <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
          </div>
          <h3 class="fw-bold text-warning mb-1"><%= @dashboard_stats[:low_stock_count] %></h3>
          <p class="text-muted small mb-2">ä½åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ</p>
          <div class="d-flex justify-content-between small text-muted">
            <span>å±é™º: <%= @dashboard_stats[:critical_stock_count] %></span>
            <span>åœ¨åº«åˆ‡ã‚Œ: <%= @dashboard_stats[:out_of_stock_count] %></span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="icon-lg mb-3 mx-auto bg-info-subtle text-info rounded-circle d-flex align-items-center justify-content-center">
            <i class="bi bi-arrow-repeat" aria-hidden="true"></i>
          </div>
          <h3 class="fw-bold text-info mb-1"><%= @dashboard_stats[:transfers_completed_today] %></h3>
          <p class="text-muted small mb-2">æœ¬æ—¥å®Œäº†ç§»å‹•</p>
          <div class="d-flex justify-content-between small text-muted">
            <span>å¹³å‡æ™‚é–“: <%= @dashboard_stats[:average_transfer_time] %>h</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ %>
  <div class="row">
    <%# å·¦ã‚«ãƒ©ãƒ : ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»ç§»å‹•ç”³è«‹ %>
    <div class="col-lg-8">
      <%# ä½åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ %>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold text-warning">
              <i class="bi bi-exclamation-triangle me-2" aria-hidden="true"></i>
              ä½åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ
            </h5>
            <span class="badge bg-warning text-dark"><%= @low_stock_items.count %>ä»¶</span>
          </div>
        </div>
        <div class="card-body p-0">
          <% if @low_stock_items.any? %>
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col" class="ps-4">å•†å“å</th>
                    <th scope="col">ç¾åœ¨åœ¨åº«</th>
                    <th scope="col">å®‰å…¨åœ¨åº«</th>
                    <th scope="col">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                    <th scope="col" class="text-center pe-4">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                  </tr>
                </thead>
                <tbody>
                  <% @low_stock_items.each do |item| %>
                    <tr>
                      <td class="ps-4">
                        <div class="fw-bold"><%= item.inventory.name %></div>
                        <small class="text-muted">
                          <%= item.inventory.code if item.inventory.respond_to?(:code) %>
                        </small>
                      </td>
                      <td>
                        <span class="fw-bold text-<%= item.quantity == 0 ? 'danger' : 'warning' %>">
                          <%= item.quantity %>
                        </span>
                        <% if item.reserved_quantity > 0 %>
                          <small class="text-muted d-block">äºˆç´„: <%= item.reserved_quantity %></small>
                        <% end %>
                      </td>
                      <td><%= item.safety_stock_level %></td>
                      <td>
                        <% case item.stock_level_status %>
                        <% when :out_of_stock %>
                          <span class="badge bg-danger">åœ¨åº«åˆ‡ã‚Œ</span>
                        <% when :critical %>
                          <span class="badge bg-danger">å±é™º</span>
                        <% when :low %>
                          <span class="badge bg-warning text-dark">ä½åœ¨åº«</span>
                        <% end %>
                      </td>
                      <td class="text-center pe-4">
                        <%= link_to new_admin_inter_store_transfer_path(
                                      source_store_id: @store.id,
                                      inventory_id: item.inventory.id
                                    ),
                                   class: "btn btn-sm btn-outline-primary",
                                   title: "ç§»å‹•ç”³è«‹" do %>
                          <i class="bi bi-plus-circle" aria-hidden="true"></i>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-4">
              <div class="icon-lg mb-3 text-success">âœ…</div>
              <h6 class="text-success mb-2">ä½åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆãªã—</h6>
              <p class="text-muted small">ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒå®‰å…¨åœ¨åº«ãƒ¬ãƒ™ãƒ«ä»¥ä¸Šã‚’ç¶­æŒã—ã¦ã„ã¾ã™ã€‚</p>
            </div>
          <% end %>
        </div>
      </div>

      <%# ç§»å‹•ç”³è«‹çŠ¶æ³ %>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold">
              <i class="bi bi-arrow-repeat me-2" aria-hidden="true"></i>
              ä¿ç•™ä¸­ã®ç§»å‹•ç”³è«‹
            </h5>
            <span class="badge bg-info"><%= @pending_transfers.count %>ä»¶</span>
          </div>
        </div>
        <div class="card-body p-0">
          <% if @pending_transfers.any? %>
            <div class="list-group list-group-flush">
              <% @pending_transfers.each do |transfer| %>
                <div class="list-group-item border-0 px-3 py-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-bold small">
                        <i class="bi bi-arrow-right text-primary me-1"></i>
                        â†’ <%= transfer.destination_store.name %>
                      </div>
                      <div class="text-muted small">
                        <%= transfer.inventory.name %> Ã— <%= transfer.quantity %>
                      </div>
                      <div class="text-muted small">
                        <%= time_ago_in_words(transfer.requested_at) %>å‰
                      </div>
                    </div>
                    <span class="badge bg-warning text-dark small">
                      æ‰¿èªå¾…ã¡
                    </span>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-4">
              <div class="icon-lg mb-3 text-muted">ğŸ“‹</div>
              <h6 class="text-muted mb-2">ä¿ç•™ä¸­ã®ç§»å‹•ç”³è«‹ãªã—</h6>
              <p class="text-muted small">ç¾åœ¨ã€æ‰¿èªå¾…ã¡ã®ç§»å‹•ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            </div>
          <% end %>
        </div>
        <div class="card-footer bg-white border-top">
          <%= link_to admin_inter_store_transfers_path(store_id: @store.id),
                     class: "btn btn-sm btn-outline-primary w-100" do %>
            ã™ã¹ã¦ã®ç§»å‹•å±¥æ­´ã‚’è¡¨ç¤º
          <% end %>
        </div>
      </div>
    </div>

    <%# å³ã‚«ãƒ©ãƒ : ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ãƒ»ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ %>
    <div class="col-lg-4">
      <%# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ %>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <h6 class="mb-0 fw-bold">
            <i class="bi bi-graph-up me-2" aria-hidden="true"></i>
            ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™
          </h6>
        </div>
        <div class="card-body">
          <div class="performance-metric mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="small text-muted">åœ¨åº«å›è»¢ç‡</span>
              <span class="fw-bold"><%= @dashboard_stats[:inventory_turnover_rate].round(1) %>å›/å¹´</span>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-success" 
                   role="progressbar" 
                   style="width: <%= [@dashboard_stats[:inventory_turnover_rate] * 20, 100].min %>%"
                   aria-valuenow="<%= @dashboard_stats[:inventory_turnover_rate] %>" 
                   aria-valuemin="0" 
                   aria-valuemax="5"></div>
            </div>
          </div>
          
          <div class="performance-metric mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="small text-muted">åœ¨åº«åŠ¹ç‡</span>
              <span class="fw-bold">
                <%= ((@dashboard_stats[:available_value].to_f / @dashboard_stats[:total_value]) * 100).round(1) %>%
              </span>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-info" 
                   role="progressbar" 
                   style="width: <%= ((@dashboard_stats[:available_value].to_f / @dashboard_stats[:total_value]) * 100).round(1) %>%"></div>
            </div>
          </div>
          
          <div class="performance-metric">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="small text-muted">åŠ¹ç‡ã‚¹ã‚³ã‚¢</span>
              <span class="fw-bold text-admin-primary"><%= @dashboard_stats[:efficiency_score] %>%</span>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-admin-primary" 
                   role="progressbar" 
                   style="width: <%= @dashboard_stats[:efficiency_score] %>%"
                   aria-valuenow="<%= @dashboard_stats[:efficiency_score] %>" 
                   aria-valuemin="0" 
                   aria-valuemax="100"></div>
            </div>
          </div>
        </div>
      </div>

      <%# ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ %>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <h6 class="mb-0 fw-bold">
            <i class="bi bi-lightning me-2" aria-hidden="true"></i>
            ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          </h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <%= link_to new_admin_inter_store_transfer_path(source_store_id: @store.id),
                       class: "btn btn-admin-primary btn-sm" do %>
              <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>
              ç§»å‹•ç”³è«‹ã‚’ä½œæˆ
            <% end %>
            <%= link_to admin_store_path(@store),
                       class: "btn btn-outline-primary btn-sm" do %>
              <i class="bi bi-eye me-1" aria-hidden="true"></i>
              åº—èˆ—è©³ç´°ã‚’è¡¨ç¤º
            <% end %>
            <% if current_admin.can_manage_store?(@store) %>
              <%= link_to edit_admin_store_path(@store),
                         class: "btn btn-outline-warning btn-sm" do %>
                <i class="bi bi-pencil me-1" aria-hidden="true"></i>
                åº—èˆ—æƒ…å ±ã‚’ç·¨é›†
              <% end %>
            <% end %>
            <%= link_to admin_inter_store_transfers_path(source_store_id: @store.id),
                       class: "btn btn-outline-info btn-sm" do %>
              <i class="bi bi-list me-1" aria-hidden="true"></i>
              ç§»å‹•å±¥æ­´ã‚’è¡¨ç¤º
            <% end %>
          </div>
        </div>
      </div>

      <%# é€±é–“ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¦‚è¦ %>
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
          <h6 class="mb-0 fw-bold">
            <i class="bi bi-calendar-week me-2" aria-hidden="true"></i>
            é€±é–“ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
          </h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <div class="border-end pe-3">
                <div class="h4 fw-bold text-success mb-1">
                  <%= @weekly_performance[:outgoing_transfers]&.values&.sum || 0 %>
                </div>
                <div class="small text-muted">é€å‡ºç§»å‹•</div>
              </div>
            </div>
            <div class="col-6">
              <div class="ps-3">
                <div class="h4 fw-bold text-info mb-1">
                  <%= @weekly_performance[:incoming_transfers]&.values&.sum || 0 %>
                </div>
                <div class="small text-muted">å—å…¥ç§»å‹•</div>
              </div>
            </div>
          </div>
          <hr class="my-3">
          <div class="text-center">
            <small class="text-muted">éå»7æ—¥é–“ã®å®Ÿç¸¾</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%# ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« %>
<style>
  .store-dashboard-icon {
    font-size: 48px;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(220, 53, 69, 0.1));
    border-radius: 50%;
  }
  
  .icon-lg {
    width: 64px;
    height: 64px;
    font-size: 28px;
  }
  
  .efficiency-score .badge {
    font-size: 0.8rem;
    padding: 0.5rem 0.75rem;
  }
  
  .performance-metric .progress {
    border-radius: 3px;
  }
  
  .btn-admin-primary {
    background-color: var(--admin-primary);
    border-color: var(--admin-primary);
    color: white;
  }
  
  .btn-admin-primary:hover {
    background-color: var(--admin-primary-dark, #0056b3);
    border-color: var(--admin-primary-dark, #0056b3);
  }
  
  .progress-bar.bg-admin-primary {
    background-color: var(--admin-primary) !important;
  }
</style>

<%# è‡ªå‹•æ›´æ–°JavaScriptï¼ˆPhase 3ã§å®Ÿè£…äºˆå®šï¼‰ %>
<script>
  // TODO: ğŸŸ¡ Phase 3ï¼ˆä¸­ï¼‰- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°æ©Ÿèƒ½
  // å„ªå…ˆåº¦: ä¸­ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Šï¼‰
  // å®Ÿè£…å†…å®¹: ActionCableã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ãƒ»ç§»å‹•çŠ¶æ³æ›´æ–°
  // æœŸå¾…åŠ¹æœ: æœ€æ–°æƒ…å ±ã®ç¢ºå®ŸãªæŠŠæ¡ã€æ„æ€æ±ºå®šã®è¿…é€ŸåŒ–
  
  document.addEventListener('DOMContentLoaded', function() {
    // è‡ªå‹•æ›´æ–°æ©Ÿèƒ½ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
    console.log('Store Dashboard loaded for <%= @store.name %>');
  });
</script>