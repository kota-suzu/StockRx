<%# 🏪 店舗情報編集 - Phase 2: Multi-Store Management %>
<div class="container-fluid py-4">
  <%# パンくずナビゲーション %>
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <%= link_to admin_stores_path, class: "text-decoration-none" do %>
          <i class="bi bi-shop me-1" aria-hidden="true"></i>店舗管理
        <% end %>
      </li>
      <li class="breadcrumb-item">
        <%= link_to admin_store_path(@store), class: "text-decoration-none" do %>
          <%= @store.name %>
        <% end %>
      </li>
      <li class="breadcrumb-item active" aria-current="page">編集</li>
    </ol>
  </nav>

  <%# ページヘッダー %>
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-lg-8">
              <div class="d-flex align-items-center">
                <div class="store-edit-icon me-3">
                  <% if @store.pharmacy? %>
                    <i class="bi bi-hospital text-admin-primary"></i>
                  <% elsif @store.warehouse? %>
                    <i class="bi bi-building text-info"></i>
                  <% else %>
                    <i class="bi bi-building-check text-success"></i>
                  <% end %>
                </div>
                <div>
                  <h1 class="h2 mb-1 fw-bold"><%= @store.name %> の編集</h1>
                  <p class="text-muted mb-0">
                    店舗情報を更新します
                    <span class="badge bg-secondary ms-2"><%= @store.code %></span>
                  </p>
                </div>
              </div>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
              <div class="btn-group" role="group" aria-label="店舗操作">
                <%= link_to admin_store_path(@store),
                           class: "btn btn-outline-primary" do %>
                  <i class="bi bi-eye me-1" aria-hidden="true"></i>
                  詳細表示
                <% end %>
                <%= link_to dashboard_admin_store_path(@store),
                           class: "btn btn-outline-info" do %>
                  <i class="bi bi-graph-up me-1" aria-hidden="true"></i>
                  ダッシュボード
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# 編集注意事項 %>
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-warning border-0" role="alert">
        <div class="d-flex">
          <div class="flex-shrink-0">
            <i class="bi bi-exclamation-triangle fs-4" aria-hidden="true"></i>
          </div>
          <div class="flex-grow-1 ms-3">
            <h5 class="alert-heading">編集時の注意事項</h5>
            <p class="mb-2">店舗情報を変更する際は、以下の点にご注意ください：</p>
            <ul class="mb-0">
              <li><strong>店舗コード</strong>の変更は既存の在庫移動履歴に影響する可能性があります</li>
              <li><strong>店舗種別</strong>の変更は権限・機能制限に影響します</li>
              <li><strong>非有効化</strong>すると新規在庫移動ができなくなります</li>
              <li>重要な変更は事前に関係者に通知してください</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# フォーム %>
  <div class="row">
    <div class="col-12">
      <%= render 'form', store: @store %>
    </div>
  </div>

  <%# 危険な操作セクション %>
  <% if current_admin.headquarters_admin? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card border-danger">
          <div class="card-header bg-danger-subtle border-danger">
            <h6 class="mb-0 fw-bold text-danger">
              <i class="bi bi-exclamation-triangle me-2" aria-hidden="true"></i>
              危険な操作
            </h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <h6 class="fw-bold text-danger">店舗を削除</h6>
                <p class="text-muted small mb-0">
                  この操作は取り消すことができません。店舗に関連する在庫データ、移動履歴、管理者情報がすべて削除されます。
                  削除前に重要なデータをバックアップしてください。
                </p>
              </div>
              <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <%= link_to admin_store_path(@store),
                           method: :delete,
                           class: "btn btn-danger",
                           data: {
                             confirm: "本当に「#{@store.name}」を削除しますか？\n\nこの操作は取り消すことができません。\n- 在庫データがすべて削除されます\n- 移動履歴が削除されます\n- 関連する管理者が無効になります\n\n削除する場合は「#{@store.name}」と入力してください。"
                           } do %>
                  <i class="bi bi-trash me-1" aria-hidden="true"></i>
                  店舗を削除
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <%# 関連情報 %>
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
          <h6 class="mb-0 fw-bold">
            <i class="bi bi-info-circle me-2" aria-hidden="true"></i>
            関連データ
          </h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-4">
              <div class="h4 fw-bold text-primary"><%= @store.store_inventories.count %></div>
              <div class="small text-muted">在庫アイテム</div>
            </div>
            <div class="col-4">
              <div class="h4 fw-bold text-info"><%= @store.admins.count %></div>
              <div class="small text-muted">管理者</div>
            </div>
            <div class="col-4">
              <div class="h4 fw-bold text-success">
                <%= @store.outgoing_transfers.count + @store.incoming_transfers.count %>
              </div>
              <div class="small text-muted">移動履歴</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-6 mt-3 mt-md-0">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
          <h6 class="mb-0 fw-bold">
            <i class="bi bi-clock-history me-2" aria-hidden="true"></i>
            更新履歴
          </h6>
        </div>
        <div class="card-body">
          <div class="small text-muted">
            <div class="mb-2">
              <strong>作成日時:</strong> <%= l(@store.created_at, format: :long) %>
            </div>
            <div class="mb-2">
              <strong>最終更新:</strong> <%= l(@store.updated_at, format: :long) %>
            </div>
            <% if @store.created_at != @store.updated_at %>
              <div class="mb-2">
                <strong>更新回数:</strong> 
                <%= time_ago_in_words(@store.updated_at) %>前に更新
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%# カスタムスタイル %>
<style>
  .store-edit-icon {
    font-size: 48px;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(220, 53, 69, 0.1));
    border-radius: 50%;
  }
  
  .text-admin-primary {
    color: var(--admin-primary) !important;
  }
  
  .bg-danger-subtle {
    background-color: rgba(220, 53, 69, 0.1) !important;
  }
</style>

<%# 削除確認の強化 JavaScript %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 削除ボタンの追加確認
    const deleteButton = document.querySelector('[data-confirm*="削除"]');
    if (deleteButton) {
      deleteButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        const storeName = '<%= @store.name %>';
        const userInput = prompt(`危険な操作です。削除を続行するには店舗名「${storeName}」を正確に入力してください:`);
        
        if (userInput === storeName) {
          if (confirm('最終確認: この店舗を完全に削除しますか？\n\nこの操作は取り消すことができません。')) {
            // フォーム送信
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = this.href;
            
            const methodInput = document.createElement('input');
            methodInput.type = 'hidden';
            methodInput.name = '_method';
            methodInput.value = 'DELETE';
            
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = 'authenticity_token';
            tokenInput.value = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            form.appendChild(methodInput);
            form.appendChild(tokenInput);
            document.body.appendChild(form);
            form.submit();
          }
        } else if (userInput !== null) {
          alert('店舗名が正しくありません。削除をキャンセルしました。');
        }
      });
    }
  });
</script>