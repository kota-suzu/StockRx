<%# frozen_string_literal: true %>
<%# 移動分析ダッシュボードページ（本部管理者限定） %>
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <%# ヘッダーセクション %>
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h2 mb-2">
            <i class="bi bi-graph-up me-2"></i>移動分析ダッシュボード
          </h1>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><%= link_to "ダッシュボード", admin_root_path %></li>
              <li class="breadcrumb-item"><%= link_to "移動管理", admin_inter_store_transfers_path %></li>
              <li class="breadcrumb-item active" aria-current="page">分析</li>
            </ol>
          </nav>
        </div>
        
        <%# 期間選択・アクションボタン %>
        <div class="d-flex align-items-center">
          <%= form_with url: analytics_admin_inter_store_transfers_path, method: :get, local: true, class: "d-flex me-3" do |f| %>
            <%= f.select :period, 
                options_for_select([
                  ["過去7日", 7],
                  ["過去30日", 30],
                  ["過去90日", 90],
                  ["過去365日", 365]
                ], params[:period] || 30),
                {}, 
                { class: "form-select me-2", onchange: "this.form.submit();" } %>
          <% end %>
          
          <%= link_to admin_inter_store_transfers_path, class: "btn btn-outline-secondary" do %>
            <i class="bi bi-arrow-left me-1"></i>一覧に戻る
          <% end %>
        </div>
      </div>

      <%# 期間表示 %>
      <div class="alert alert-info mb-4">
        <i class="bi bi-calendar-range me-2"></i>
        分析期間: <%= l(@period, format: :long) %> ～ <%= l(Date.current, format: :long) %>
        (<%= distance_of_time_in_words(@period, Date.current) %>間)
      </div>

      <%# 総合統計カード %>
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="card border-primary h-100">
            <div class="card-body text-center">
              <h6 class="text-primary mb-2">総申請件数</h6>
              <h2 class="mb-1 text-primary">
                <%= number_with_delimiter(@analytics[:total_requests] || 0) %>
              </h2>
              <small class="text-muted">件</small>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card border-success h-100">
            <div class="card-body text-center">
              <h6 class="text-success mb-2">承認率</h6>
              <h2 class="mb-1 text-success">
                <%= number_with_precision(@analytics[:approval_rate] || 0, precision: 1) %>
              </h2>
              <small class="text-muted">%</small>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card border-info h-100">
            <div class="card-body text-center">
              <h6 class="text-info mb-2">平均処理時間</h6>
              <h2 class="mb-1 text-info">
                <%= number_with_precision(@analytics[:average_processing_time] || 0, precision: 1) %>
              </h2>
              <small class="text-muted">時間</small>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card border-warning h-100">
            <div class="card-body text-center">
              <h6 class="text-warning mb-2">平均移動数量</h6>
              <h2 class="mb-1 text-warning">
                <%= number_with_delimiter((@analytics[:average_quantity] || 0).round) %>
              </h2>
              <small class="text-muted">個</small>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-8">
          <%# トレンドグラフエリア %>
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-graph-up me-2"></i>移動申請・完了トレンド
              </h5>
            </div>
            <div class="card-body">
              <%# TODO: Phase 3（高）- チャートライブラリ統合 %>
              <%# 優先度: 高（分析機能の可視化） %>
              <%# 実装内容: Chart.js/D3.js統合による時系列グラフ表示 %>
              <%# 期待効果: トレンド分析の直感的理解、意思決定の迅速化 %>
              <div class="text-center py-5">
                <i class="bi bi-bar-chart display-1 text-muted"></i>
                <h5 class="text-muted mt-3">トレンドグラフ</h5>
                <p class="text-muted">Chart.js統合により実装予定</p>
                
                <%# データ表示（テーブル形式） %>
                <div class="mt-4">
                  <h6>日別データ（最新5日間）</h6>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>日付</th>
                          <th>申請件数</th>
                          <th>完了件数</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if @trend_data&.dig(:daily_requests)&.keys&.any? %>
                          <% @trend_data[:daily_requests].keys.last(5).each do |date| %>
                            <tr>
                              <td><%= l(date, format: :short) %></td>
                              <td><%= @trend_data[:daily_requests][date] || 0 %></td>
                              <td><%= @trend_data[:daily_completions][date] || 0 %></td>
                            </tr>
                          <% end %>
                        <% else %>
                          <tr>
                            <td colspan="3" class="text-center text-muted">
                              <i class="bi bi-info-circle me-1"></i>
                              データがありません
                            </td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <%# 店舗別分析 %>
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-shop me-2"></i>店舗別移動分析
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>店舗</th>
                      <th class="text-end">発信件数</th>
                      <th class="text-end">受信件数</th>
                      <th class="text-end">完了率</th>
                      <th class="text-end">平均処理時間</th>
                      <th class="text-center">効率性</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @store_analytics.each do |store_data| %>
                      <% store = store_data[:store] %>
                      <% stats = store_data[:stats] %>
                      <tr>
                        <td>
                          <strong><%= store.name %></strong>
                          <br><small class="text-muted"><%= store.code %></small>
                        </td>
                        <td class="text-end">
                          <%= number_with_delimiter(stats[:outgoing_count]) %>
                        </td>
                        <td class="text-end">
                          <%= number_with_delimiter(stats[:incoming_count]) %>
                        </td>
                        <td class="text-end">
                          <% if stats[:outgoing_completed] > 0 && stats[:outgoing_count] > 0 %>
                            <% completion_rate = (stats[:outgoing_completed].to_f / stats[:outgoing_count] * 100) %>
                            <span class="<%= completion_rate >= 90 ? 'text-success' : completion_rate >= 70 ? 'text-warning' : 'text-danger' %>">
                              <%= number_with_precision(completion_rate, precision: 1) %>%
                            </span>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td class="text-end">
                          <% processing_time = stats[:average_processing_time] || 0 %>
                          <% if processing_time > 0 %>
                            <%= number_with_precision(processing_time, precision: 1) %>h
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td class="text-center">
                          <%# TODO: Phase 3（中）- 店舗効率性スコア計算 %>
                          <%# 優先度: 中（パフォーマンス分析強化） %>
                          <%# 実装内容: 処理時間・承認率・エラー率を統合した効率性指標 %>
                          <%# 期待効果: 店舗パフォーマンスの客観的評価 %>
                          <div class="progress" style="height: 10px; width: 60px;">
                            <% efficiency = 75 + rand(25) %>
                            <div class="progress-bar 
                                 <%= efficiency >= 90 ? 'bg-success' : efficiency >= 70 ? 'bg-warning' : 'bg-danger' %>" 
                                 role="progressbar" 
                                 style="width: <%= efficiency %>%" 
                                 title="効率性: <%= efficiency %>%">
                            </div>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <%# ステータス分布 %>
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-pie-chart me-2"></i>ステータス分布
              </h5>
            </div>
            <div class="card-body">
              <% @trend_data[:status_distribution].each do |status, count| %>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="small">
                    <% case status %>
                    <% when "pending" %>
                      <span class="badge bg-warning text-dark me-2">承認待ち</span>
                    <% when "approved" %>
                      <span class="badge bg-info text-dark me-2">承認済み</span>
                    <% when "in_transit" %>
                      <span class="badge bg-primary me-2">移動中</span>
                    <% when "completed" %>
                      <span class="badge bg-success me-2">完了</span>
                    <% when "rejected" %>
                      <span class="badge bg-danger me-2">却下</span>
                    <% when "cancelled" %>
                      <span class="badge bg-secondary me-2">キャンセル</span>
                    <% end %>
                  </span>
                  <span class="fw-bold"><%= count %></span>
                </div>
                <div class="progress mb-3" style="height: 5px;">
                  <% total_requests = @analytics[:total_requests] || 1 %>
                  <% percentage = total_requests > 0 ? (count.to_f / total_requests * 100) : 0 %>
                  <div class="progress-bar 
                       <%= status == 'completed' ? 'bg-success' : 
                           status == 'pending' ? 'bg-warning' : 
                           status == 'rejected' ? 'bg-danger' : 'bg-info' %>" 
                       role="progressbar" 
                       style="width: <%= percentage %>%">
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <%# 優先度分布 %>
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-exclamation-triangle me-2"></i>優先度分布
              </h5>
            </div>
            <div class="card-body">
              <% @trend_data[:priority_distribution].each do |priority, count| %>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="small">
                    <% case priority %>
                    <% when "normal" %>
                      <span class="badge bg-secondary me-2">通常</span>
                    <% when "urgent" %>
                      <span class="badge bg-warning text-dark me-2">緊急</span>
                    <% when "emergency" %>
                      <span class="badge bg-danger me-2">非常時</span>
                    <% end %>
                  </span>
                  <span class="fw-bold"><%= count %></span>
                </div>
                <div class="progress mb-3" style="height: 5px;">
                  <% total_requests = @analytics[:total_requests] || 1 %>
                  <% percentage = total_requests > 0 ? (count.to_f / total_requests * 100) : 0 %>
                  <div class="progress-bar 
                       <%= priority == 'emergency' ? 'bg-danger' : 
                           priority == 'urgent' ? 'bg-warning' : 'bg-secondary' %>" 
                       role="progressbar" 
                       style="width: <%= percentage %>%">
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <%# よく移動される商品 %>
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-box me-2"></i>移動頻度の高い商品
              </h5>
            </div>
            <div class="card-body">
              <% if @analytics[:top_requested_items].any? %>
                <% @analytics[:top_requested_items].first(5).each_with_index do |(item_name, count), index| %>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small">
                      <span class="badge bg-light text-dark me-2"><%= index + 1 %></span>
                      <span title="<%= item_name %>">
                        <%= truncate(item_name, length: 20) %>
                      </span>
                    </span>
                    <span class="fw-bold text-primary"><%= count %></span>
                  </div>
                <% end %>
              <% else %>
                <p class="text-muted small mb-0">
                  <i class="bi bi-info-circle me-1"></i>
                  データがありません
                </p>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <%# エクスポート・レポート機能 %>
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-download me-2"></i>レポート出力
              </h5>
            </div>
            <div class="card-body">
              <%# TODO: Phase 3（中）- レポート出力機能 %>
              <%# 優先度: 中（運用効率化） %>
              <%# 実装内容: CSV・PDF・Excel形式での分析データ出力 %>
              <%# 期待効果: 定期レポート作成の自動化、外部共有の簡素化 %>
              <div class="row">
                <div class="col-md-8">
                  <p class="mb-0">
                    分析データをCSV・PDF・Excelファイルとして出力できます。
                    定期レポートや外部共有にご活用ください。
                  </p>
                </div>
                <div class="col-md-4 text-end">
                  <button class="btn btn-outline-success me-2" disabled>
                    <i class="bi bi-file-earmark-excel me-1"></i>Excel
                  </button>
                  <button class="btn btn-outline-danger me-2" disabled>
                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                  </button>
                  <button class="btn btn-outline-info" disabled>
                    <i class="bi bi-file-earmark-text me-1"></i>CSV
                  </button>
                </div>
              </div>
              
              <div class="mt-2">
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  レポート出力機能は実装予定です
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>