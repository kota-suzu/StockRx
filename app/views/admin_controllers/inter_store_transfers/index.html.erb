<%# frozen_string_literal: true %>
<%# 店舗間移動一覧ページ %>
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <%# ヘッダーセクション %>
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h2 mb-2">
            <i class="bi bi-truck me-2"></i>店舗間移動管理
          </h1>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><%= link_to "ダッシュボード", admin_root_path %></li>
              <li class="breadcrumb-item active" aria-current="page">移動管理</li>
            </ol>
          </nav>
        </div>
        
        <%# アクションボタン %>
        <div>
          <%= link_to new_admin_inter_store_transfer_path, class: "btn btn-primary" do %>
            <i class="bi bi-plus-circle me-1"></i>新規移動申請
          <% end %>
          
          <% if current_admin.headquarters_admin? %>
            <%= link_to analytics_admin_inter_store_transfers_path, class: "btn btn-outline-info ms-2" do %>
              <i class="bi bi-graph-up me-1"></i>分析ダッシュボード
            <% end %>
          <% end %>
        </div>
      </div>

      <%# 統計カード %>
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="card border-primary">
            <div class="card-body">
              <h6 class="text-primary mb-1">総移動件数</h6>
              <h3 class="mb-0"><%= number_with_delimiter(@stats[:total_transfers]) %></h3>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card border-warning">
            <div class="card-body">
              <h6 class="text-warning mb-1">承認待ち</h6>
              <h3 class="mb-0">
                <%= @stats[:pending_count] %>
                <% if @stats[:urgent_pending] > 0 || @stats[:emergency_pending] > 0 %>
                  <small class="text-danger ms-2">
                    緊急: <%= @stats[:urgent_pending] + @stats[:emergency_pending] %>
                  </small>
                <% end %>
              </h3>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card border-success">
            <div class="card-body">
              <h6 class="text-success mb-1">本日完了</h6>
              <h3 class="mb-0"><%= @stats[:completed_today] %></h3>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card border-info">
            <div class="card-body">
              <h6 class="text-info mb-1">平均処理時間</h6>
              <h3 class="mb-0"><%= @stats[:average_processing_time] %> 時間</h3>
            </div>
          </div>
        </div>
      </div>

      <%# 検索・フィルター %>
      <%= form_with url: admin_inter_store_transfers_path, method: :get, local: true, class: "mb-4" do |f| %>
        <div class="card">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <%= f.text_field :search, 
                    value: params[:search],
                    class: "form-control", 
                    placeholder: "商品名・店舗名で検索..." %>
              </div>
              
              <div class="col-md-2">
                <%= f.select :status, 
                    options_for_select([
                      ["すべてのステータス", ""],
                      ["承認待ち", "pending"],
                      ["承認済み", "approved"],
                      ["却下", "rejected"],
                      ["移動中", "in_transit"],
                      ["完了", "completed"],
                      ["キャンセル", "cancelled"]
                    ], params[:status]),
                    {}, 
                    class: "form-select" %>
              </div>
              
              <div class="col-md-2">
                <%= f.select :priority, 
                    options_for_select([
                      ["すべての優先度", ""],
                      ["通常", "normal"],
                      ["緊急", "urgent"],
                      ["非常時", "emergency"]
                    ], params[:priority]),
                    {}, 
                    class: "form-select" %>
              </div>
              
              <div class="col-md-2">
                <%= f.select :store_id, 
                    options_for_select([["すべての店舗", ""]] + 
                      Store.active.accessible_to_admin(current_admin).map { |s| [s.name, s.id] }, 
                      params[:store_id]),
                    {}, 
                    class: "form-select" %>
              </div>
              
              <div class="col-md-2">
                <%= f.submit "検索", class: "btn btn-primary w-100" %>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <%# 移動申請一覧 %>
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">移動申請一覧</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th style="width: 100px;">申請日</th>
                  <th>優先度</th>
                  <th>ステータス</th>
                  <th>移動元 → 移動先</th>
                  <th>商品</th>
                  <th class="text-end">数量</th>
                  <th>申請者</th>
                  <th class="text-center" style="min-width: 180px;">
                    <i class="bi bi-gear me-1" aria-hidden="true"></i>操作
                  </th>
                </tr>
              </thead>
              <tbody>
                <% if @transfers.any? %>
                  <% @transfers.each do |transfer| %>
                    <tr>
                      <td>
                        <%= l(transfer.requested_at, format: :short) %>
                      </td>
                      <td>
                        <% case transfer.priority %>
                        <% when "emergency" %>
                          <span class="badge bg-danger">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i><%= transfer.priority_text %>
                          </span>
                        <% when "urgent" %>
                          <span class="badge bg-warning text-dark">
                            <i class="bi bi-exclamation-circle-fill me-1"></i><%= transfer.priority_text %>
                          </span>
                        <% else %>
                          <span class="badge bg-secondary"><%= transfer.priority_text %></span>
                        <% end %>
                      </td>
                      <td>
                        <% case transfer.status %>
                        <% when "pending" %>
                          <span class="badge bg-warning text-dark">
                            <i class="bi bi-clock me-1"></i><%= transfer.status_text %>
                          </span>
                        <% when "approved" %>
                          <span class="badge bg-info text-dark">
                            <i class="bi bi-check-circle me-1"></i><%= transfer.status_text %>
                          </span>
                        <% when "in_transit" %>
                          <span class="badge bg-primary">
                            <i class="bi bi-truck me-1"></i><%= transfer.status_text %>
                          </span>
                        <% when "completed" %>
                          <span class="badge bg-success">
                            <i class="bi bi-check-all me-1"></i><%= transfer.status_text %>
                          </span>
                        <% when "rejected" %>
                          <span class="badge bg-danger">
                            <i class="bi bi-x-circle me-1"></i><%= transfer.status_text %>
                          </span>
                        <% when "cancelled" %>
                          <span class="badge bg-secondary">
                            <i class="bi bi-dash-circle me-1"></i><%= transfer.status_text %>
                          </span>
                        <% end %>
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <span class="text-truncate" style="max-width: 150px;" 
                                title="<%= transfer.source_store.name %>">
                            <%= transfer.source_store.name %>
                          </span>
                          <i class="bi bi-arrow-right mx-2 text-muted"></i>
                          <span class="text-truncate" style="max-width: 150px;"
                                title="<%= transfer.destination_store.name %>">
                            <%= transfer.destination_store.name %>
                          </span>
                        </div>
                      </td>
                      <td>
                        <span class="text-truncate d-inline-block" style="max-width: 200px;"
                              title="<%= transfer.inventory.name %>">
                          <%= transfer.inventory.name %>
                        </span>
                      </td>
                      <td class="text-end">
                        <%= number_with_delimiter(transfer.quantity) %>
                      </td>
                      <td>
                        <%= transfer.requested_by.display_name %>
                      </td>
                      <td class="text-center" style="min-width: 180px;">
                        <div class="action-buttons-group d-flex justify-content-center gap-1">
                          <%# 詳細ボタン %>
                          <%= link_to admin_inter_store_transfer_path(transfer), 
                                      class: "btn btn-primary btn-sm action-btn detail-btn",
                                      title: "詳細表示",
                                      data: { 
                                        bs_toggle: "tooltip",
                                        bs_placement: "top"
                                      },
                                      "aria-label": "移動申請詳細を表示" do %>
                            <i class="bi bi-eye" aria-hidden="true"></i>
                            <span class="btn-text d-none d-lg-inline ms-1">詳細</span>
                          <% end %>
                          
                          <%# 承認・却下ボタン（権限チェック） %>
                          <% if transfer.pending? && current_admin.can_approve_transfers? %>
                            <%= link_to admin_inter_store_transfer_path(transfer), 
                                        class: "btn btn-success btn-sm action-btn approval-btn",
                                        title: "承認・却下",
                                        data: { 
                                          bs_toggle: "tooltip",
                                          bs_placement: "top"
                                        },
                                        "aria-label": "移動申請を承認・却下" do %>
                              <i class="bi bi-check-lg" aria-hidden="true"></i>
                              <span class="btn-text d-none d-lg-inline ms-1">承認</span>
                            <% end %>
                          <% end %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                <% else %>
                  <tr>
                    <td colspan="8" class="text-center py-4 text-muted">
                      <i class="bi bi-inbox display-4 d-block mb-2"></i>
                      移動申請がありません
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
        
        <% if @transfers.any? %>
          <div class="card-footer">
            <%= paginate @transfers %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<%# 統一されたアクションボタンスタイル（CLAUDE.md準拠） %>
<style>
  /* アクションボタンの基本スタイル（inventoriesから継承） */
  .action-buttons-group {
    min-width: 180px;
  }
  
  .action-btn {
    min-width: 38px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.375rem;
    transition: all 0.15s ease-in-out;
    position: relative;
  }
  
  /* デスクトップ表示：アイコン + テキスト */
  @media (min-width: 992px) {
    .action-btn {
      min-width: 80px;
      padding: 0.375rem 0.75rem;
    }
  }
  
  /* 詳細ボタン */
  .detail-btn {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
  }
  
  .detail-btn:hover, .detail-btn:focus {
    background-color: var(--bs-blue);
    border-color: var(--bs-blue);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.15);
  }
  
  /* 承認ボタン */
  .approval-btn {
    background-color: var(--bs-success);
    border-color: var(--bs-success);
    color: white;
  }
  
  .approval-btn:hover, .approval-btn:focus {
    background-color: #198754;
    border-color: #157347;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 0.125rem 0.25rem rgba(25, 135, 84, 0.3);
  }
  
  /* アクセシビリティ：フォーカス表示の強化 */
  .action-btn:focus {
    outline: 2px solid var(--bs-primary);
    outline-offset: 2px;
  }
  
  /* モバイル対応：タッチデバイスでのタップ領域確保 */
  @media (max-width: 991.98px) {
    .action-btn {
      min-width: 44px;
      height: 44px;
      margin: 0 1px;
    }
    
    .btn-text {
      display: none !important;
    }
  }
  
  /* TODO: Phase 3 - 店舗間移動特有の機能
   * - 優先度別のボタン色分け（緊急移動は赤色等）
   * - ステータス変更アニメーション
   * - 一括承認・却下機能
   */
</style>