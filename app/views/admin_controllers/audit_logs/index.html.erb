<%# frozen_string_literal: true %>
<%# ============================================ %>
<%# Phase 5-2: „Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âåñ %>
<%# Áõ£Êüª„É≠„Ç∞‰∏ÄË¶ßÁîªÈù¢ %>
<%# CLAUDE.mdÊ∫ñÊã†: GDPR/PCI DSSÂØæÂøú %>
<%# ============================================ %>

<% content_for :title, "Áõ£Êüª„É≠„Ç∞" %>

<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="h2 mb-3">
        <i class="bi bi-shield-check me-2"></i>
        Áõ£Êüª„É≠„Ç∞
      </h1>
      
      <%# Áµ±Ë®à„Çµ„Éû„É™„Éº %>
      <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card border-primary">
            <div class="card-body">
              <h5 class="card-title text-muted">Á∑è„Ç§„Éô„É≥„ÉàÊï∞</h5>
              <p class="card-text">
                <span class="h2"><%= number_with_delimiter(@stats[:total_events] || 0) %></span>
              </p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card border-warning">
            <div class="card-body">
              <h5 class="card-title text-muted">Áï∞Â∏∏Ê§úÁü•</h5>
              <p class="card-text">
                <span class="h2 text-warning">
                  <%= @anomalies&.count || 0 %>
                </span>
              </p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card border-info">
            <div class="card-body">
              <h5 class="card-title text-muted">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº</h5>
              <p class="card-text">
                <span class="h2"><%= @stats[:unique_users] || 0 %></span>
              </p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card border-danger">
            <div class="card-body">
              <h5 class="card-title text-muted">„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç§„Éô„É≥„Éà</h5>
              <p class="card-text">
                <span class="h2 text-danger">
                  <%= @stats[:security_events] || 0 %>
                </span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <%# Ê§úÁ¥¢„Éï„Ç©„Éº„É† %>
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-search me-2"></i>Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Éº
          </h5>
        </div>
        <div class="card-body">
          <%= form_with url: admin_audit_logs_path, method: :get, local: true, class: "row g-3" do |f| %>
            <div class="col-md-3">
              <%= f.text_field :user_email, 
                              value: params[:user_email],
                              class: "form-control", 
                              placeholder: "„É¶„Éº„Ç∂„Éº„É°„Éº„É´" %>
            </div>
            
            <div class="col-md-3">
              <%= f.select :action, 
                          options_for_select([
                            ["„Åô„Åπ„Å¶„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥", ""],
                            ["„É≠„Ç∞„Ç§„É≥", "login"],
                            ["„É≠„Ç∞„Ç¢„Ç¶„Éà", "logout"],
                            ["‰ΩúÊàê", "create"],
                            ["Êõ¥Êñ∞", "update"],
                            ["ÂâäÈô§", "delete"],
                            ["Èñ≤Ë¶ß", "view"],
                            ["„Ç®„ÇØ„Çπ„Éù„Éº„Éà", "export"]
                          ], params[:action]),
                          {}, 
                          class: "form-select" %>
            </div>
            
            <div class="col-md-2">
              <%= f.date_field :start_date, 
                              value: params[:start_date],
                              class: "form-control" %>
            </div>
            
            <div class="col-md-2">
              <%= f.date_field :end_date, 
                              value: params[:end_date],
                              class: "form-control" %>
            </div>
            
            <div class="col-md-2">
              <%= f.submit "Ê§úÁ¥¢", class: "btn btn-primary w-100" %>
            </div>
          <% end %>
        </div>
      </div>

      <%# Áõ£Êüª„É≠„Ç∞„ÉÜ„Éº„Éñ„É´ %>
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-list-ul me-2"></i>Áõ£Êüª„É≠„Ç∞‰∏ÄË¶ß
          </h5>
          <div>
            <%= link_to admin_audit_logs_path(format: :csv, params: request.query_parameters), 
                        class: "btn btn-sm btn-outline-secondary" do %>
              <i class="bi bi-download me-1"></i>CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
            <% end %>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Êó•ÊôÇ</th>
                  <th>„É¶„Éº„Ç∂„Éº</th>
                  <th>„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                  <th>ÂØæË±°</th>
                  <th>„É°„ÉÉ„Çª„Éº„Ç∏</th>
                  <th>IP„Ç¢„Éâ„É¨„Çπ</th>
                  <th>Ë©≥Á¥∞</th>
                </tr>
              </thead>
              <tbody>
                <% if @audit_logs.any? %>
                  <% @audit_logs.each do |log| %>
                    <tr>
                      <td><%= l(log.created_at, format: :long) %></td>
                      <td>
                        <% if log.user %>
                          <%= log.user.email %>
                        <% else %>
                          <span class="text-muted">„Ç∑„Çπ„ÉÜ„É†</span>
                        <% end %>
                      </td>
                      <td>
                        <span class="badge bg-<%= audit_log_action_color(log.action) %>">
                          <%= log.action %>
                        </span>
                      </td>
                      <td>
                        <% if log.auditable %>
                          <small class="text-muted">
                            <%= log.auditable_type %>#<%= log.auditable_id %>
                          </small>
                        <% else %>
                          -
                        <% end %>
                      </td>
                      <td><%= truncate(log.message, length: 50) %></td>
                      <td><small><%= log.ip_address %></small></td>
                      <td>
                        <%= link_to admin_audit_log_path(log), 
                                    class: "btn btn-sm btn-outline-primary" do %>
                          <i class="bi bi-eye"></i>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                <% else %>
                  <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                      Áõ£Êüª„É≠„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          
          <% if @audit_logs.any? %>
            <div class="card-footer">
              <%= paginate @audit_logs %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<%# TODO: üî¥ Phase 6ÔºàÁ∑äÊÄ•Ôºâ- „É™„Ç¢„É´„Çø„Ç§„É†Áõ£Êüª„É≠„Ç∞Áõ£Ë¶ñ %>
<%# ÂÑ™ÂÖàÂ∫¶: È´òÔºà„Çª„Ç≠„É•„É™„ÉÜ„Ç£Áõ£Ë¶ñÔºâ %>
<%# ÂÆüË£ÖÂÜÖÂÆπ: %>
<%#   - ActionCable„Å´„Çà„Çã„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞ %>
<%#   - Áï∞Â∏∏Ê§úÁü•„Ç¢„É©„Éº„Éà %>
<%#   - Ëá™Âãï„Éñ„É≠„ÉÉ„ÇØÊ©üËÉΩ %>
<%# ÊúüÂæÖÂäπÊûú: „Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç§„É≥„Ç∑„Éá„É≥„Éà„ÅÆÊó©ÊúüÁô∫Ë¶ã„Å®ÂØæÂøú %>