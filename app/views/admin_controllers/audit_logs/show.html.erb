<%# frozen_string_literal: true %>
<%# ============================================ %>
<%# Phase 5-2: „Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âåñ %>
<%# Áõ£Êüª„É≠„Ç∞Ë©≥Á¥∞ÁîªÈù¢ %>
<%# ============================================ %>

<% content_for :title, "Áõ£Êüª„É≠„Ç∞Ë©≥Á¥∞" %>

<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h2 mb-0">
          <i class="bi bi-shield-check me-2"></i>
          Áõ£Êüª„É≠„Ç∞Ë©≥Á¥∞
        </h1>
        <%= link_to admin_audit_logs_path, class: "btn btn-outline-secondary" do %>
          <i class="bi bi-arrow-left me-1"></i>‰∏ÄË¶ß„Å´Êàª„Çã
        <% end %>
      </div>

      <%# Âü∫Êú¨ÊÉÖÂ†± %>
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>
            Âü∫Êú¨ÊÉÖÂ†±
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <th scope="row" style="width: 30%;">ID</th>
                  <td><code>#<%= @audit_log.id %></code></td>
                </tr>
                <tr>
                  <th scope="row">Êó•ÊôÇ</th>
                  <td><%= l(@audit_log.created_at, format: :long) %></td>
                </tr>
                <tr>
                  <th scope="row">„É¶„Éº„Ç∂„Éº</th>
                  <td>
                    <% if @audit_log.user %>
                      <strong><%= @audit_log.user.email %></strong>
                      <br><small class="text-muted">ID: <%= @audit_log.user.id %></small>
                    <% else %>
                      <span class="text-muted">„Ç∑„Çπ„ÉÜ„É†</span>
                    <% end %>
                  </td>
                </tr>
                <tr>
                  <th scope="row">„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                  <td>
                    <span class="badge bg-<%= audit_log_action_color(@audit_log.action) %> fs-6">
                      <%= @audit_log.action %>
                    </span>
                  </td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <th scope="row" style="width: 30%;">IP„Ç¢„Éâ„É¨„Çπ</th>
                  <td><code><%= @audit_log.ip_address %></code></td>
                </tr>
                <tr>
                  <th scope="row">User Agent</th>
                  <td>
                    <small class="text-muted">
                      <%= truncate(@audit_log.user_agent, length: 50) %>
                    </small>
                  </td>
                </tr>
                <tr>
                  <th scope="row">ÂØæË±°„É™„ÇΩ„Éº„Çπ</th>
                  <td>
                    <% if @audit_log.auditable %>
                      <strong><%= @audit_log.auditable_type %></strong>
                      <br><small class="text-muted">ID: <%= @audit_log.auditable_id %></small>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                </tr>
                <tr>
                  <th scope="row">„É°„ÉÉ„Çª„Éº„Ç∏</th>
                  <td><%= @audit_log.message %></td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <%# Ë©≥Á¥∞ÊÉÖÂ†± %>
      <% if @audit_log.details.present? %>
        <div class="card mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">
              <i class="bi bi-code me-2"></i>
              Ë©≥Á¥∞ÊÉÖÂ†±
            </h5>
          </div>
          <div class="card-body">
            <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(@audit_log.details) %></code></pre>
          </div>
        </div>
      <% end %>

      <%# Èñ¢ÈÄ£„É≠„Ç∞ %>
      <% if @related_logs&.any? %>
        <div class="card mb-4">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">
              <i class="bi bi-link me-2"></i>
              Èñ¢ÈÄ£„Åô„ÇãÁõ£Êüª„É≠„Ç∞
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>Êó•ÊôÇ</th>
                    <th>„É¶„Éº„Ç∂„Éº</th>
                    <th>„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                    <th>„É°„ÉÉ„Çª„Éº„Ç∏</th>
                    <th>Ë©≥Á¥∞</th>
                  </tr>
                </thead>
                <tbody>
                  <% @related_logs.each do |log| %>
                    <tr>
                      <td><%= l(log.created_at, format: :short) %></td>
                      <td>
                        <% if log.user %>
                          <%= log.user.email %>
                        <% else %>
                          <span class="text-muted">„Ç∑„Çπ„ÉÜ„É†</span>
                        <% end %>
                      </td>
                      <td>
                        <span class="badge bg-<%= audit_log_action_color(log.action) %>">
                          <%= log.action %>
                        </span>
                      </td>
                      <td><%= truncate(log.message, length: 50) %></td>
                      <td>
                        <%= link_to admin_audit_log_path(log), 
                                    class: "btn btn-sm btn-outline-primary" do %>
                          <i class="bi bi-eye"></i>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      <% end %>

      <%# „Çª„Ç≠„É•„É™„ÉÜ„Ç£ÊÉÖÂ†± %>
      <% if @audit_log.action.in?(%w[login logout failed_login permission_change]) %>
        <div class="card border-warning">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
              <i class="bi bi-shield-exclamation me-2"></i>
              „Çª„Ç≠„É•„É™„ÉÜ„Ç£Èñ¢ÈÄ£ÊÉÖÂ†±
            </h5>
          </div>
          <div class="card-body">
            <div class="alert alert-warning">
              <strong>Ê≥®ÊÑè:</strong> „Åì„ÅÆ„É≠„Ç∞„ÅØ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Å´Èñ¢ÈÄ£„Åô„Çã„Ç§„Éô„É≥„Éà„Åß„Åô„ÄÇ
              ‰∏çÂØ©„Å™Ê¥ªÂãï„ÇÑÁï∞Â∏∏„Å™Ë°åÂãï„Éë„Çø„Éº„É≥„Åå„Å™„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            </div>
            
            <% if @audit_log.user %>
              <div class="row">
                <div class="col-md-6">
                  <h6>„É¶„Éº„Ç∂„ÉºË©≥Á¥∞</h6>
                  <ul class="list-unstyled">
                    <li><strong>Role:</strong> <%= @audit_log.user.role %></li>
                    <li><strong>Last Sign In:</strong> <%= @audit_log.user.last_sign_in_at ? l(@audit_log.user.last_sign_in_at, format: :short) : 'N/A' %></li>
                    <li><strong>Sign In Count:</strong> <%= @audit_log.user.sign_in_count %></li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6>„Ç¢„ÇØ„Çª„ÇπÊÉÖÂ†±</h6>
                  <ul class="list-unstyled">
                    <li><strong>IP Address:</strong> <code><%= @audit_log.ip_address %></code></li>
                    <li><strong>User Agent:</strong> <small><%= truncate(@audit_log.user_agent, length: 40) %></small></li>
                  </ul>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%# TODO: üü° Phase 6ÔºàÈáçË¶ÅÔºâ- Áõ£Êüª„É≠„Ç∞ÂàÜÊûêÊ©üËÉΩ %>
<%# ÂÑ™ÂÖàÂ∫¶: ‰∏≠ÔºàÂàÜÊûêÊ©üËÉΩÂº∑ÂåñÔºâ %>
<%# ÂÆüË£ÖÂÜÖÂÆπ: %>
<%#   - Èñ¢ÈÄ£„É≠„Ç∞„ÅÆÊôÇÁ≥ªÂàóÂàÜÊûê %>
<%#   - Áï∞Â∏∏„Éë„Çø„Éº„É≥Ê§úÁü• %>
<%#   - „É™„Çπ„ÇØ„Çπ„Ç≥„Ç¢Ë°®Á§∫ %>
<%# ÊúüÂæÖÂäπÊûú: „Çà„ÇäË©≥Á¥∞„Å™„É≠„Ç∞ÂàÜÊûê„Å´„Çà„ÇãËÑÖÂ®ÅÊ§úÁü• %>